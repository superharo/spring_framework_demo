> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [www.iocoder.cn](https://www.iocoder.cn/Spring-Security/OAuth2-learning/?self)

> æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Spring-Security/OAuth2-learning/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼ 1. æ¦‚è¿° 2. å¯†ç æ¨¡å¼ 3.......

<div id="locker" style="display: block;"> <div class="mask"></div> <div class="info"> <div> <p class="text-center" style="color: black;"> æ‰«ç å…³æ³¨å…¬ä¼—å·ï¼š<span style="color: #E9405A; font-weight: bold;"> èŠ‹é“æºç  </span></p> <p class="text-center"></p> <p class="text-center"> <span style="color: black;"> å‘é€ï¼š</span> <span class="token" style="color: #e9415a; font-weight: bold; font-size: 17px; margin-bottom: 45px;"> ç™¾äº‹å¯ä¹ </span> <br> <span style="color: black;"> è·å–æ°¸ä¹…è§£é”æœ¬ç«™å…¨éƒ¨æ–‡ç« çš„é“¾æ¥ </span> </p> </div> <div class="text-center"> <img class="code-img" style="width: 300px" src="/images/common/erweima.jpg"> </div> </div> </div>

æ‘˜è¦: åŸåˆ›å‡ºå¤„ http://www.iocoder.cn/Spring-Security/OAuth2-learning/ ã€ŒèŠ‹é“æºç ã€æ¬¢è¿è½¬è½½ï¼Œä¿ç•™æ‘˜è¦ï¼Œè°¢è°¢ï¼

*   [1. æ¦‚è¿°](http://www.iocoder.cn/Spring-Security/OAuth2-learning/)
*   [2. å¯†ç æ¨¡å¼](http://www.iocoder.cn/Spring-Security/OAuth2-learning/)
*   [3. æˆæƒç æ¨¡å¼](http://www.iocoder.cn/Spring-Security/OAuth2-learning/)
*   [4. ç®€åŒ–æ¨¡å¼](http://www.iocoder.cn/Spring-Security/OAuth2-learning/)
*   [5. å®¢æˆ·ç«¯æ¨¡å¼](http://www.iocoder.cn/Spring-Security/OAuth2-learning/)
*   [6. åˆå¹¶æœåŠ¡å™¨](http://www.iocoder.cn/Spring-Security/OAuth2-learning/)
*   [7. åˆ·æ–°ä»¤ç‰Œ](http://www.iocoder.cn/Spring-Security/OAuth2-learning/)
*   [8. åˆ é™¤ä»¤ç‰Œ](http://www.iocoder.cn/Spring-Security/OAuth2-learning/)
*   [666. å½©è›‹](http://www.iocoder.cn/Spring-Security/OAuth2-learning/)

> æœ¬æ–‡åœ¨æä¾›å®Œæ•´ä»£ç ç¤ºä¾‹ï¼Œå¯è§ [https://github.com/YunaiV/SpringBoot-Labs](https://github.com/YunaiV/SpringBoot-Labs) çš„ [lab-68-spring-security-oauth](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-68-spring-security-oauth) ç›®å½•ã€‚
> 
> åŸåˆ›ä¸æ˜“ï¼Œç»™ç‚¹ä¸ª [Star](https://github.com/YunaiV/SpringBoot-Labs/stargazers) å˜¿ï¼Œä¸€èµ·å†²é¸­ï¼

åœ¨[ã€ŠèŠ‹é“ Spring Boot å®‰å…¨æ¡†æ¶ Spring Security å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/Spring-Security/?self)æ–‡ç« ä¸­ï¼Œè‰¿è‰¿åˆ†äº«äº†å¦‚ä½•ä½¿ç”¨ Spring Security å®ç°è®¤è¯ä¸æˆæƒçš„åŠŸèƒ½ï¼Œè·å¾—å¹¿å¤§å¥³ç²‰ä¸çš„å¥½è¯„ã€‚

äºæ˜¯ä¹ï¼Œè‰¿è‰¿å‡†å¤‡å†æ¥åˆ†äº«ä¸€æ³¢ [Spring Security OAuth](https://github.com/spring-projects/spring-security-oauth) æ¡†æ¶ï¼Œçœ‹çœ‹åœ¨ Spring Security å¦‚ä½•å®ç° OAuth2.0 å®ç°**æˆæƒ**çš„åŠŸèƒ½ã€‚

> æ—ç™½å›ï¼šå®é™…ä¸Šè‰¿è‰¿å¾ˆæ—©å†™äº†ä¸€ç¯‡å…³äº Spring Security OAuth çš„[æ–‡ç« ](http://www.iocoder.cn/Spring-Security/OAuth2-learning-learning/)ï¼Œè€ƒè™‘åˆ°ç‰ˆæœ¬å¤ªè€ï¼Œæä¾›çš„ç¤ºä¾‹åˆè¿‡äºç®€å•ï¼Œæ‰€ä»¥æœ¬æ–‡ä¹Ÿæ˜¯è¯¥æ–‡ç« çš„å‡çº§ç‰ˆã€‚

å¯èƒ½æœ‰èƒ–å‹å¯¹ OAuth2.0 ä¸æ˜¯å¾ˆäº†è§£ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥ç®€å•ä»‹ç»ä¸‹å®ƒã€‚å¯èƒ½èƒ–å‹çœ‹ OAuth2.0 çš„æ¦‚å¿µä¼šæœ‰ç‚¹æ‡µé€¼ï¼Œä¸è¦æ‹…å¿ƒï¼Œåç»­çœ‹å®Œè‰¿è‰¿æä¾›çš„ç¤ºä¾‹ä»£ç ï¼Œä¼šçªç„¶æ¸…æ™°çš„å“ˆã€‚

å¦å¤–ï¼Œé˜®ä¸€å³°æä¾›äº†å‡ ç¯‡å…³äº OAuth2.0 éå¸¸ä¸é”™çš„æ–‡ç« ï¼Œæ¨èèƒ–å‹å»ä»ç…ç…ã€‚åŒæ—¶ï¼Œæœ¬æ–‡ä¹Ÿä¼šç›´æ¥å¼•ç”¨å®ƒçš„å†…å®¹ï¼Œæ–¹ä¾¿èƒ–å‹ç»Ÿä¸€ç†è§£ã€‚

*   [ã€Šç†è§£ OAuth2.0ã€‹](http://www.iocoder.cn/Fight/ruanyifeng-oauth_2_0/?self)
*   [ã€ŠOAuth2.0 çš„ä¸€ä¸ªç®€å•è§£é‡Šã€‹](http://www.iocoder.cn/Fight/ruanyifeng-oauth_design/?self)
*   [ã€ŠOAuth2.0 çš„å››ç§æ–¹å¼ã€‹](http://www.iocoder.cn/Fight/ruanyifeng-oauth-grant-types/?self)
*   [ã€ŠGitHub OAuth ç¬¬ä¸‰æ–¹ç™»å½•ç¤ºä¾‹æ•™ç¨‹ã€‹](http://www.iocoder.cn/Fight/ruanyifeng-github-oauth/?self)

1.1 OAuth2.0 æ˜¯ä»€ä¹ˆï¼Ÿ
-----------------

> FROM [ã€Šç»´åŸºç™¾ç§‘ â€”â€” å¼€æ”¾æˆæƒã€‹](https://zh.wikipedia.org/wiki/%E5%BC%80%E6%94%BE%E6%8E%88%E6%9D%83)

OAuth(Open Authorization) æ˜¯ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œå…è®¸ç”¨æˆ·è®©ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®è¯¥ç”¨æˆ·åœ¨æŸä¸€ç½‘ç«™ä¸Šå­˜å‚¨çš„ç§å¯†çš„èµ„æºï¼ˆå¦‚ç…§ç‰‡ï¼Œè§†é¢‘ï¼Œè”ç³»äººåˆ—è¡¨ï¼‰ï¼Œ**è€Œæ— éœ€å°†ç”¨æˆ·åå’Œå¯†ç æä¾›ç»™ç¬¬ä¸‰æ–¹åº”ç”¨**ã€‚

> æ—ç™½å›ï¼šå¾ˆå¤šå›¢é˜Ÿï¼Œå†…éƒ¨ä¼šé‡‡ç”¨ OAuth2.0 å®ç°ä¸€ä¸ª**æˆæƒ**æœåŠ¡ï¼Œé¿å…æ¯ä¸ªä¸Šå±‚åº”ç”¨æˆ–è€…æœåŠ¡é‡å¤å¼€å‘ã€‚

OAuth å…è®¸ç”¨æˆ·æä¾›ä¸€ä¸ª**ä»¤ç‰Œ**ï¼Œè€Œä¸æ˜¯ç”¨æˆ·åå’Œå¯†ç æ¥è®¿é—®ä»–ä»¬å­˜æ”¾åœ¨ç‰¹å®šæœåŠ¡æä¾›è€…çš„æ•°æ®ã€‚

æ¯ä¸€ä¸ªä»¤ç‰Œæˆæƒä¸€ä¸ªç‰¹å®šçš„ç½‘ç«™ï¼ˆä¾‹å¦‚ï¼Œè§†é¢‘ç¼–è¾‘ç½‘ç«™) åœ¨ç‰¹å®šçš„æ—¶æ®µï¼ˆä¾‹å¦‚ï¼Œæ¥ä¸‹æ¥çš„ 2 å°æ—¶å†…ï¼‰å†…è®¿é—®**ç‰¹å®šçš„èµ„æº**ï¼ˆä¾‹å¦‚ä»…ä»…æ˜¯æŸä¸€ç›¸å†Œä¸­çš„è§†é¢‘ï¼‰ã€‚è¿™æ ·ï¼ŒOAuth è®©ç”¨æˆ·å¯ä»¥æˆæƒç¬¬ä¸‰æ–¹ç½‘ç«™è®¿é—®ä»–ä»¬å­˜å‚¨åœ¨å¦å¤–æœåŠ¡æä¾›è€…çš„æŸäº›ç‰¹å®šä¿¡æ¯ï¼Œè€Œéæ‰€æœ‰å†…å®¹ã€‚

> æ—ç™½å›ï¼šå¦‚æœèƒ–å‹å¯¹æ¥è¿‡[å¾®ä¿¡ç½‘é¡µæˆæƒ](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html)åŠŸèƒ½ï¼Œå°±ä¼šå‘ç°åˆ†æˆä¸¤ç§æ–¹å¼ï¼š**é™é»˜**æˆæƒã€**æ‰‹åŠ¨**æˆæƒã€‚å‰è€…åªèƒ½è·å–åˆ°ç”¨æˆ·çš„ **openid**ï¼Œè€Œåè€…å¯ä»¥è·å–åˆ°ç”¨æˆ·çš„**åŸºæœ¬ä¿¡æ¯**ã€‚

OAuth2.0 æ˜¯ç”¨äºæˆæƒçš„**è¡Œä¸šæ ‡å‡†åè®®**ã€‚OAuth2.0 ä¸ºç®€åŒ–å®¢æˆ·ç«¯å¼€å‘æä¾›äº†ç‰¹å®šçš„æˆæƒæµï¼ŒåŒ…æ‹¬ Web åº”ç”¨ã€æ¡Œé¢åº”ç”¨ã€ç§»åŠ¨ç«¯åº”ç”¨ç­‰ã€‚

> æ—ç™½å›ï¼šOAuth 1.0 åè®®ä½“ç³»æœ¬èº«å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œç°å·²è¢«å„å¤§å¼€å‘å¹³å°é€æ¸åºŸå¼ƒã€‚

1.2 OAuth2.0 è§’è‰²è§£é‡Š
-----------------

åœ¨ OAuth2.0 ä¸­ï¼Œæœ‰å¦‚ä¸‹è§’è‰²ï¼š

â‘  **Authorization** Serverï¼š**è®¤è¯**æœåŠ¡å™¨ï¼Œç”¨äºè®¤è¯ç”¨æˆ·ã€‚å¦‚æœå®¢æˆ·ç«¯è®¤è¯é€šè¿‡ï¼Œåˆ™å‘æ”¾è®¿é—®èµ„æºæœåŠ¡å™¨çš„**ä»¤ç‰Œ**ã€‚

â‘¡ **Resource** Serverï¼š**èµ„æº**æœåŠ¡å™¨ï¼Œæ‹¥æœ‰å—ä¿æŠ¤èµ„æºã€‚å¦‚æœè¯·æ±‚åŒ…å«æ­£ç¡®çš„**è®¿é—®ä»¤ç‰Œ**ï¼Œåˆ™å¯ä»¥è®¿é—®èµ„æºã€‚

> å‹æƒ…æç¤ºï¼šæä¾›ç®¡ç†åå°ã€å®¢æˆ·ç«¯ API çš„æœåŠ¡ï¼Œéƒ½å¯ä»¥è®¤ä¸ºæ˜¯ Resource Serverã€‚

â‘¢ **Client**ï¼šå®¢æˆ·ç«¯ã€‚å®ƒè¯·æ±‚èµ„æºæœåŠ¡å™¨æ—¶ï¼Œä¼šå¸¦ä¸Š**è®¿é—®ä»¤ç‰Œ**ï¼Œä»è€ŒæˆåŠŸè®¿é—®èµ„æºã€‚

> å‹æƒ…æç¤ºï¼šClient å¯ä»¥æ˜¯æµè§ˆå™¨ã€å®¢æˆ·ç«¯ï¼Œä¹Ÿå¯ä»¥æ˜¯å†…éƒ¨æœåŠ¡ã€‚

â‘£ Resource **Owner**ï¼šèµ„æºæ‹¥æœ‰è€…ã€‚æœ€ç»ˆç”¨æˆ·ï¼Œä»–æœ‰è®¿é—®èµ„æºçš„**è´¦å·**ä¸**å¯†ç **ã€‚

> å‹æƒ…æç¤ºï¼šå¯ä»¥ç®€å•æŠŠ Resource Owner ç†è§£æˆäººï¼Œå¥¹åœ¨ä½¿ç”¨ Client è®¿é—®èµ„æºã€‚

1.3 OAuth 2.0 è¿è¡Œæµç¨‹
------------------

å¦‚ä¸‹æ˜¯ OAuth 2.0 çš„**æˆæƒç æ¨¡å¼**çš„è¿è¡Œæµç¨‹ï¼š

![](https://static.iocoder.cn/6a92a862da97a4692c755c7e186dfd07.jpg)

> *   ï¼ˆAï¼‰ç”¨æˆ·æ‰“å¼€å®¢æˆ·ç«¯ä»¥åï¼Œå®¢æˆ·ç«¯è¦æ±‚ç”¨æˆ·ç»™äºˆæˆæƒã€‚
> *   ï¼ˆBï¼‰ç”¨æˆ·åŒæ„ç»™äºˆå®¢æˆ·ç«¯æˆæƒã€‚
> *   ï¼ˆCï¼‰å®¢æˆ·ç«¯ä½¿ç”¨ä¸Šä¸€æ­¥è·å¾—çš„æˆæƒï¼Œå‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œã€‚
> *   ï¼ˆDï¼‰è®¤è¯æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯è¿›è¡Œè®¤è¯ä»¥åï¼Œç¡®è®¤æ— è¯¯ï¼ŒåŒæ„å‘æ”¾ä»¤ç‰Œã€‚
> *   ï¼ˆEï¼‰å®¢æˆ·ç«¯ä½¿ç”¨ä»¤ç‰Œï¼Œå‘èµ„æºæœåŠ¡å™¨ç”³è¯·è·å–èµ„æºã€‚
> *   ï¼ˆFï¼‰èµ„æºæœåŠ¡å™¨ç¡®è®¤ä»¤ç‰Œæ— è¯¯ï¼ŒåŒæ„å‘å®¢æˆ·ç«¯å¼€æ”¾èµ„æºã€‚

ä¸Šè¿°çš„å…­ä¸ªæ­¥éª¤ï¼Œ**B æ˜¯å…³é”®**ï¼Œå³ç”¨æˆ·å¦‚ä½•ç»™å®¢æˆ·ç«¯è¿›è¡Œ**æˆæƒ**ã€‚æœ‰äº†æˆæƒä¹‹ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥è·å–**ä»¤ç‰Œ**ï¼Œè¿›è€Œå‡­ä»¤ç‰Œè·å–**èµ„æº**ã€‚

> å‹æƒ…æç¤ºï¼šå¦‚æœèƒ–å‹æœ‰å¯¹æ¥è¿‡ä¸‰æ–¹å¼€æ”¾å¹³å°ï¼Œä¾‹å¦‚è¯´å¾®ä¿¡ã€QQã€å¾®åšç­‰ä¸‰æ–¹ç™»å½•ï¼Œå°±ä¼šå¾ˆå®¹æ˜“ç†è§£è¿™ä¸ªæ­¥éª¤è¿‡ç¨‹ã€‚
> 
> è¿™ä¸ªæ—¶å€™çš„èµ„æºï¼Œèµ„æºä¸»è¦æŒ‡çš„æ˜¯ä¸‰æ–¹å¼€æ”¾å¹³å°çš„ç”¨æˆ·èµ„æ–™ç­‰ç­‰ã€‚

1.4 OAuth 2.0 æˆæƒæ¨¡å¼
------------------

å®¢æˆ·ç«¯å¿…é¡»å¾—åˆ°ç”¨æˆ·çš„æˆæƒï¼ˆAuthorization Grantï¼‰ï¼Œæ‰èƒ½è·å¾—è®¿é—®ä»¤ç‰Œï¼ˆAccess Tokenï¼‰ã€‚

OAuth2.0 å®šä¹‰äº†å››ç§æˆæƒæ–¹å¼ï¼š

*   æˆæƒç æ¨¡å¼ï¼ˆAuthorization Codeï¼‰
*   å¯†ç æ¨¡å¼ï¼ˆResource Owner Password Credentialsï¼‰
*   ç®€åŒ–æ¨¡å¼ï¼ˆImplicitï¼‰
*   å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆClient Credentialsï¼‰

å…¶ä¸­ï¼Œ**å¯†ç æ¨¡å¼**å’Œ**æˆæƒç æ¨¡å¼**æ¯”è¾ƒå¸¸ç”¨ã€‚è‡³äºå¦‚ä½•é€‰æ‹©ï¼Œè‰¿è‰¿è¿™é‡Œå…ˆæå‰å‰§é€ä¸‹ï¼Œåç»­æ…¢æ…¢ç»†å“ã€‚

> FROM [ã€Šæ·±åº¦å‰–æ OAuth2 å’Œå¾®æœåŠ¡å®‰å…¨æ¶æ„ã€‹](https://portal.qiniu.com/bucket/blog/resource)
> 
> ![](https://static.iocoder.cn/images/Spring-Security/2018_10_01/15.png)

å½“ç„¶ï¼Œå¯¹äº**é»„æ¡†**éƒ¨åˆ†ï¼Œå¯¹äºç¬”è€…è¿˜æ˜¯æ¯”è¾ƒå›°æƒ‘çš„ã€‚ç¬”è€…è®¤ä¸ºï¼Œç¬¬ä¸‰æ–¹çš„å•é¡µåº”ç”¨ SPA ï¼Œä¹Ÿæ˜¯é€‚åˆé‡‡ç”¨ Authorization Code Grant æˆæƒæ¨¡å¼çš„ã€‚ä¾‹å¦‚ï¼Œ[ã€Šå¾®ä¿¡ç½‘é¡µæˆæƒã€‹](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421140842) ï¼š

> å…·ä½“è€Œè¨€ï¼Œç½‘é¡µæˆæƒæµç¨‹åˆ†ä¸ºå››æ­¥ï¼š
> 
> *   1ã€å¼•å¯¼ç”¨æˆ·è¿›å…¥æˆæƒé¡µé¢åŒæ„æˆæƒï¼Œè·å– code
> *   2ã€é€šè¿‡ code æ¢å–ç½‘é¡µæˆæƒ access_tokenï¼ˆä¸åŸºç¡€æ”¯æŒä¸­çš„ access_toke n ä¸åŒï¼‰
> *   3ã€å¦‚æœéœ€è¦ï¼Œå¼€å‘è€…å¯ä»¥åˆ·æ–°ç½‘é¡µæˆæƒ access_tokenï¼Œé¿å…è¿‡æœŸ
> *   4ã€é€šè¿‡ç½‘é¡µæˆæƒ access_token å’Œ openid è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆæ”¯æŒ UnionID æœºåˆ¶ï¼‰

æ‰€ä»¥ï¼Œè‰¿è‰¿çŒœæµ‹ï¼Œä¹‹æ‰€ä»¥å›¾ä¸­ç”»çš„æ˜¯ Implicit Grant çš„åŸå› æ˜¯ï¼Œå— Google çš„ [ã€ŠOAuth 2.0 for Client-side Web Applicationsã€‹](https://developers.google.com/identity/protocols/OAuth2UserAgent) ä¸€æ–‡ä¸­ï¼Œæ¨èä½¿ç”¨äº† Implicit Grant ã€‚

å½“ç„¶ï¼Œå…·ä½“ä½¿ç”¨ Implicit Grant è¿˜æ˜¯ Authorization Code Grant æˆæƒæ¨¡å¼ï¼Œæ²¡æœ‰å®šè®ºã€‚ç¬”è€…ï¼Œåå‘äºä½¿ç”¨ **Authorization Code Grant**ï¼Œå¯¹äºç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯çš„åœºæ™¯ã€‚

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š
> 
> *   æˆæƒæœåŠ¡å™¨ï¼š[`lab-68-demo02-authorization-server-with-resource-owner-password-credentials`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-authorization-server-with-resource-owner-password-credentials/)
> *   èµ„æºæœåŠ¡å™¨ï¼š[`lab-68-demo02-resource-server`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/)

æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬æ¥å­¦ä¹ **å¯†ç æ¨¡å¼ï¼ˆResource Owner Password Credentials Grantï¼‰**ã€‚

å¯†ç æ¨¡å¼ï¼Œç”¨æˆ·å‘å®¢æˆ·ç«¯æä¾›è‡ªå·±çš„**ç”¨æˆ·åå’Œå¯†ç **ã€‚å®¢æˆ·ç«¯ä½¿ç”¨è¿™äº›ä¿¡æ¯ï¼Œå‘**æˆæƒæœåŠ¡å™¨**ç´¢è¦æˆæƒã€‚

åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œç”¨æˆ·å¿…é¡»æŠŠè‡ªå·±çš„å¯†ç ç»™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯å®¢æˆ·ç«¯ä¸å¾—å‚¨å­˜å¯†ç ã€‚è¿™é€šå¸¸ç”¨åœ¨ç”¨æˆ·å¯¹å®¢æˆ·ç«¯é«˜åº¦ä¿¡ä»»çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯æ˜¯æ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œæˆ–è€…ç”±ä¸€ä¸ªè‘—åå…¬å¸å‡ºå“ã€‚è€ŒæˆæƒæœåŠ¡å™¨åªæœ‰åœ¨å…¶ä»–æˆæƒæ¨¡å¼æ— æ³•æ‰§è¡Œçš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½è€ƒè™‘ä½¿ç”¨è¿™ç§æ¨¡å¼ã€‚

> æ—ç™½å›ï¼šå¦‚æœå®¢æˆ·ç«¯å’ŒæˆæƒæœåŠ¡å™¨éƒ½æ˜¯è‡ªå·±å…¬å¸çš„ï¼Œæ˜¾ç„¶ç¬¦åˆã€‚

![](https://static.iocoder.cn/1e7d96e9ed5ab025afd37c1ca97d1b39.jpg)

> *   ï¼ˆAï¼‰ç”¨æˆ·å‘å®¢æˆ·ç«¯æä¾›ç”¨æˆ·åå’Œå¯†ç ã€‚
> *   ï¼ˆBï¼‰å®¢æˆ·ç«¯å°†**ç”¨æˆ·åå’Œå¯†ç **å‘ç»™æˆæƒæœåŠ¡å™¨ï¼Œå‘åè€…**è¯·æ±‚ä»¤ç‰Œ**ã€‚
> *   ï¼ˆCï¼‰æˆæƒæœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯æä¾›è®¿é—®ä»¤ç‰Œã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥æ–°å»ºä¸¤ä¸ªé¡¹ç›®ï¼Œæ­å»ºä¸€ä¸ªå¯†ç æ¨¡å¼çš„ä½¿ç”¨ç¤ºä¾‹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/01.png)

*   [`lab-68-demo02-authorization-server-with-resource-owner-password-credentials`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-authorization-server-with-resource-owner-password-credentials/)ï¼šæˆæƒæœåŠ¡å™¨ã€‚
*   [`lab-68-demo02-resource-server`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/)ï¼šèµ„æºæœåŠ¡å™¨ã€‚

2.1 æ­å»ºæˆæƒæœåŠ¡å™¨
-----------

åˆ›å»º [`lab-68-demo02-authorization-server-with-resource-owner-password-credentials`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-authorization-server-with-resource-owner-password-credentials/) é¡¹ç›®ï¼Œæ­å»ºæˆæƒæœåŠ¡å™¨ã€‚

### 2.1.1 å¼•å…¥ä¾èµ–

åˆ›å»º [`pom.xml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-authorization-server-with-resource-owner-password-credentials/pom.xml) æ–‡ä»¶ï¼Œå¼•å…¥ Spring Security OAuth ä¾èµ–ã€‚

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>lab-68</artifactId>
        <groupId>cn.iocoder.springboot.labs</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>lab-68-demo02-authorization-server-with-resource-owner-password-credentials</artifactId>

    <properties>
        
        <spring.boot.version>2.2.4.RELEASE</spring.boot.version>
        
        <maven.compiler.target>1.8</maven.compiler.target>
        <maven.compiler.source>1.8</maven.compiler.source>
    </properties>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-parent</artifactId>
                <version>${spring.boot.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
        
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        
        <dependency>
            <groupId>org.springframework.security.oauth.boot</groupId>
            <artifactId>spring-security-oauth2-autoconfigure</artifactId>
            <version>${spring.boot.version}</version>
        </dependency>
    </dependencies>

</project>
```

æ·»åŠ  [`spring-security-oauth2-autoconfigure`](https://www.iocoder.cn/Spring-Security/OAuth2-learning/spring-security-oauth2-autoconfigure) ä¾èµ–ï¼Œå¼•å…¥ Spring Security OAuth å¹¶å®ç°è‡ªåŠ¨é…ç½®ã€‚åŒæ—¶ï¼Œå®ƒä¹Ÿå¼•å…¥äº† Spring Security ä¾èµ–ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/02.png)

### 2.1.2 SecurityConfig

åˆ›å»º [SecurityConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-authorization-server-with-resource-owner-password-credentials/src/main/java/cn/iocoder/springboot/lab68/authorizationserverdemo/config/SecurityConfig.java) é…ç½®ç±»ï¼Œæä¾›ä¸€ä¸ªè´¦å·å¯†ç ä¸ºã€Œyunai/1024ã€çš„ç”¨æˆ·ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {

    @Override
    @Bean(name = BeanIds.AUTHENTICATION_MANAGER)
    public AuthenticationManager authenticationManagerBean() throws Exception {
        return super.authenticationManagerBean();
    }

    @Bean
    public static NoOpPasswordEncoder passwordEncoder() {
        return (NoOpPasswordEncoder) NoOpPasswordEncoder.getInstance();
    }

    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.
                
                inMemoryAuthentication()
                
                .passwordEncoder(passwordEncoder())
                
                .withUser("yunai").password("1024").roles("USER");
    }

}
```

æˆ‘ä»¬é€šè¿‡ **Spring Security æä¾›è®¤è¯åŠŸèƒ½**ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦é…ç½®ä¸€ä¸ªç”¨æˆ·ã€‚

> å‹æƒ…æç¤ºï¼šçœ‹ä¸æ‡‚è¿™ä¸ªé…ç½®çš„èƒ–å‹ï¼Œåç»­å¯å›[ã€ŠèŠ‹é“ Spring Boot å®‰å…¨æ¡†æ¶ Spring Security å…¥é—¨ã€‹](http://www.iocoder.cn/Spring-Boot/Spring-Security/?self)é‡é€ ä¸‹ã€‚

### 2.1.3 OAuth2AuthorizationServerConfig

åˆ›å»º [OAuth2AuthorizationServerConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-authorization-server-with-resource-owner-password-credentials/src/main/java/cn/iocoder/springboot/lab68/authorizationserverdemo/config/OAuth2AuthorizationServerConfig.java) é…ç½®ç±»ï¼Œè¿›è¡Œ**æˆæƒ**æœåŠ¡å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@Configuration
@EnableAuthorizationServer
public class OAuth2AuthorizationServerConfig extends AuthorizationServerConfigurerAdapter {

    


    @Autowired
    private AuthenticationManager authenticationManager;

    @Override
    public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {
        endpoints.authenticationManager(authenticationManager);
    }

    @Override
    public void configure(AuthorizationServerSecurityConfigurer oauthServer) throws Exception {
        oauthServer.checkTokenAccess("isAuthenticated()");
    }

    @Override
    public void configure(ClientDetailsServiceConfigurer clients) throws Exception {
        clients.inMemory() 
                .withClient("clientapp").secret("112233") 
                .authorizedGrantTypes("password") 
                .scopes("read_userinfo", "read_contacts") 

                ;
    }

}
```

â‘  åœ¨ç±»ä¸Šæ·»åŠ  [`@EnableAuthorizationServer`](https://github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/config/annotation/web/configuration/EnableAuthorizationServer.java) æ³¨è§£ï¼Œå£°æ˜å¼€å¯ OAuth **æˆæƒ**æœåŠ¡å™¨çš„åŠŸèƒ½ã€‚

åŒæ—¶ï¼Œç»§æ‰¿ [AuthorizationServerConfigurerAdapter](https://github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/config/annotation/web/configuration/AuthorizationServerConfigurerAdapter.java) ç±»ï¼Œè¿›è¡Œ OAuth **æˆæƒ**æœåŠ¡å™¨çš„é…ç½®ã€‚

â‘¡ `#configure(AuthorizationServerEndpointsConfigurer endpoints)` æ–¹æ³•ï¼Œé…ç½®ä½¿ç”¨çš„ AuthenticationManager å®ç°**ç”¨æˆ·è®¤è¯**çš„åŠŸèƒ½ã€‚å…¶ä¸­ï¼Œ`authenticationManager` æ˜¯ç”±[ã€Œ2.1.2 SecurityConfigã€](#)åˆ›å»ºï¼ŒSpring Security çš„é…ç½®ç±»ã€‚

â‘¢ `#configure(AuthorizationServerSecurityConfigurer oauthServer)` æ–¹æ³•ï¼Œè®¾ç½® `/oauth/check_token` ç«¯ç‚¹ï¼Œé€šè¿‡è®¤è¯åå¯è®¿é—®ã€‚

> å‹æƒ…æç¤ºï¼šè¿™é‡Œçš„è®¤è¯ï¼ŒæŒ‡çš„æ˜¯ä½¿ç”¨ `client-id` + `client-secret` è¿›è¡Œçš„**å®¢æˆ·ç«¯**è®¤è¯ï¼Œä¸è¦å’Œ**ç”¨æˆ·**è®¤è¯æ··æ·†ã€‚

å…¶ä¸­ï¼Œ`/oauth/check_token` ç«¯ç‚¹å¯¹åº” [CheckTokenEndpoint](https://github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/provider/endpoint/CheckTokenEndpoint.java) ç±»ï¼Œç”¨äºæ ¡éªŒè®¿é—®ä»¤ç‰Œçš„æœ‰æ•ˆæ€§ã€‚

*   åœ¨å®¢æˆ·ç«¯è®¿é—®èµ„æºæœåŠ¡å™¨æ—¶ï¼Œä¼šåœ¨è¯·æ±‚ä¸­å¸¦ä¸Š**è®¿é—®ä»¤ç‰Œ**ã€‚
*   åœ¨èµ„æºæœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚æ—¶ï¼Œä¼šä½¿ç”¨è¯·æ±‚ä¸­çš„**è®¿é—®ä»¤ç‰Œ**ï¼Œæ‰¾æˆæƒæœåŠ¡å™¨ç¡®è®¤è¯¥**è®¿é—®ä»¤ç‰Œ**çš„æœ‰æ•ˆæ€§ã€‚

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/03.png)

â‘£ `#configure(ClientDetailsServiceConfigurer clients)` æ–¹æ³•ï¼Œè¿›è¡Œ Client å®¢æˆ·ç«¯çš„é…ç½®ã€‚

`<4.1>` å¤„ï¼Œè®¾ç½®ä½¿ç”¨åŸºäº**å†…å­˜**çš„ Client å­˜å‚¨å™¨ã€‚å®é™…æƒ…å†µä¸‹ï¼Œæœ€å¥½æ”¾å…¥**æ•°æ®åº“**ä¸­ï¼Œæ–¹ä¾¿ç®¡ç†ã€‚

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/04.png)

`<4.2>` å¤„ï¼Œåˆ›å»ºä¸€ä¸ª Client é…ç½®ã€‚å¦‚æœè¦ç»§ç»­æ·»åŠ å¦å¤–çš„ Client é…ç½®ï¼Œå¯ä»¥åœ¨ `<4.3>` å¤„ä½¿ç”¨ `#and()` æ–¹æ³•ç»§ç»­æ‹¼æ¥ã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„ `.withClient("clientapp").secret("112233")` ä»£ç æ®µï¼Œå°±æ˜¯ `client-id` å’Œ `client-secret`ã€‚

> è¡¥å……çŸ¥è¯†ï¼šå¯èƒ½ä¼šæœ‰èƒ–å‹ä¼šé—®ï¼Œä¸ºä»€ä¹ˆè¦åˆ›å»º Client çš„ `client-id` å’Œ `client-secret` å‘¢ï¼Ÿ
> 
> é€šè¿‡ `client-id` ç¼–å·å’Œ `client-secret`ï¼ŒæˆæƒæœåŠ¡å™¨å¯ä»¥çŸ¥é“è°ƒç”¨çš„æ¥æºä»¥åŠæ­£ç¡®æ€§ã€‚è¿™æ ·ï¼Œå³ä½¿ â€œåäººâ€ æ‹¿åˆ° Access Token ï¼Œä½†æ˜¯æ²¡æœ‰ `client-id` ç¼–å·å’Œ `client-secret`ï¼Œä¹Ÿä¸èƒ½å’ŒæˆæƒæœåŠ¡å™¨å‘ç”Ÿ**æœ‰æ•ˆ**çš„äº¤äº’ã€‚

### 2.1.4 AuthorizationServerApplication

åˆ›å»º [AuthorizationServerApplication](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-authorization-server-with-resource-owner-password-credentials/src/main/java/cn/iocoder/springboot/lab68/authorizationserverdemo/AuthorizationServerApplication.java) ç±»ï¼ŒæˆæƒæœåŠ¡å™¨çš„å¯åŠ¨ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@SpringBootApplication
public class AuthorizationServerApplication {

    public static void main(String[] args) {
        SpringApplication.run(AuthorizationServerApplication.class, args);
    }

}
```

### 2.1.5 ç®€å•æµ‹è¯•

æ‰§è¡Œ AuthorizationServerApplication å¯åŠ¨æˆæƒæœåŠ¡å™¨ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬ä½¿ç”¨ **Postman æ¨¡æ‹Ÿä¸€ä¸ª Client**ã€‚

â‘  `POST` è¯·æ±‚ [http://localhost:8080/oauth/token](http://localhost:8080/oauth/token) åœ°å€ï¼Œä½¿ç”¨å¯†ç æ¨¡å¼è¿›è¡Œ**æˆæƒ**ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

è¯·æ±‚è¯´æ˜ï¼š

*   é€šè¿‡ [Basic Auth](https://en.wikipedia.org/wiki/Basic_access_authentication) çš„æ–¹å¼ï¼Œå¡«å†™ `client-id` + `client-secret` ä½œä¸ºç”¨æˆ·åä¸å¯†ç ï¼Œå®ç° Client å®¢æˆ·ç«¯æœ‰æ•ˆæ€§çš„è®¤è¯ã€‚
*   è¯·æ±‚å‚æ•° `grant_type` ä¸º `"password"`ï¼Œè¡¨ç¤ºä½¿ç”¨**å¯†ç æ¨¡å¼**ã€‚
*   è¯·æ±‚å‚æ•° `username` å’Œ `password`ï¼Œè¡¨ç¤º**ç”¨æˆ·**çš„ç”¨æˆ·åä¸å¯†ç ã€‚

å“åº”è¯´æ˜ï¼š

*   å“åº”å­—æ®µ `access_token` ä¸º**è®¿é—®ä»¤ç‰Œ**ï¼Œåç»­å®¢æˆ·ç«¯åœ¨è®¿é—®èµ„æºæœåŠ¡å™¨æ—¶ï¼Œé€šè¿‡å®ƒä½œä¸ºèº«ä»½çš„æ ‡è¯†ã€‚
*   å“åº”å­—æ®µ `token_type` ä¸º**ä»¤ç‰Œç±»å‹**ï¼Œä¸€èˆ¬æ˜¯ `bearer` æˆ–æ˜¯ `mac` ç±»å‹ã€‚
*   å“åº”å­—æ®µ `expires_in` ä¸ºè®¿é—®ä»¤ç‰Œçš„**è¿‡æœŸæ—¶é—´**ï¼Œå•ä½ä¸ºç§’ã€‚
*   å“åº”å­—æ®µ `scope` ä¸º**æƒé™èŒƒå›´**ã€‚

> å‹æƒ…æç¤ºï¼š`/oauth/token` å¯¹åº” [TokenEndpoint](https://github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/provider/endpoint/TokenEndpoint.java) ç«¯ç‚¹ï¼Œæä¾› OAuth2.0 çš„å››ç§æˆæƒæ¨¡å¼ã€‚æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥åç»­å»æ’¸æ’¸ã€‚

â‘¡ `POST` è¯·æ±‚ [http://localhost:8080/oauth/check_token](http://localhost:8080/oauth/check_token) åœ°å€ï¼Œæ ¡éªŒè®¿é—®ä»¤ç‰Œçš„æœ‰æ•ˆæ€§ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

è¯·æ±‚å’Œå“åº”æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±ç…ç…å³å¯ã€‚

2.2 æ­å»ºèµ„æºæœåŠ¡å™¨
-----------

åˆ›å»º [`lab-68-demo02-resource-server`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/) é¡¹ç›®ï¼Œæ­å»ºèµ„æºæœåŠ¡å™¨ã€‚

### 2.2.1 å¼•å…¥ä¾èµ–

åˆ›å»º [`pom.xml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/pom.xml) æ–‡ä»¶ï¼Œå¼•å…¥ Spring Security OAuth ä¾èµ–ã€‚

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>lab-68</artifactId>
        <groupId>cn.iocoder.springboot.labs</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>lab-68-demo02-resource-server</artifactId>

    <properties>
        
        <spring.boot.version>2.2.4.RELEASE</spring.boot.version>
        
        <maven.compiler.target>1.8</maven.compiler.target>
        <maven.compiler.source>1.8</maven.compiler.source>
    </properties>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-parent</artifactId>
                <version>${spring.boot.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <dependencies>
        
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        
        <dependency>
            <groupId>org.springframework.security.oauth.boot</groupId>
            <artifactId>spring-security-oauth2-autoconfigure</artifactId>
            <version>${spring.boot.version}</version>
        </dependency>
    </dependencies>

</project>
```

> å‹æƒ…æç¤ºï¼šå’Œ[ã€Œ2.1.1 å¼•å…¥ä¾èµ–ã€](#)å°èŠ‚ï¼Œæ˜¯ä¸€è‡´çš„å“ˆã€‚

### 2.2.2 é…ç½®æ–‡ä»¶

åˆ›å»º [`application.yml`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/src/main/resources/application.yml) é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ  Spring Security OAuth ç›¸å…³é…ç½®ã€‚

```
server:
  port: 9090

security:
  oauth2:
    
    client:
      client-id: clientapp
      client-secret: 112233
    
    resource:
      token-info-uri: http://127.0.0.1:8080/oauth/check_token 
    
    access-token-uri: http://127.0.0.1:8080/oauth/token
```

â‘  `security.oauth2.client` é…ç½®é¡¹ï¼ŒOAuth2 Client é…ç½®ï¼Œå¯¹åº” [OAuth2ClientProperties](https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/security/oauth2/client/OAuth2ClientProperties.java) ç±»ã€‚åœ¨è¿™ä¸ªé…ç½®é¡¹ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†å®¢æˆ·ç«¯çš„ `client-id` å’Œ `client-secret`ã€‚

ä¸ºä»€ä¹ˆè¦æ·»åŠ è¿™ä¸ªé…ç½®é¡¹å‘¢ï¼Ÿå› ä¸ºèµ„æºæœåŠ¡å™¨ä¼šè°ƒç”¨æˆæƒæœåŠ¡å™¨çš„ `/oauth/check_token` æ¥å£ï¼Œè€Œè€ƒè™‘åˆ°å®‰å…¨æ€§ï¼Œæˆ‘ä»¬é…ç½®äº†è¯¥æ¥å£éœ€è¦è¿›è¿‡**å®¢æˆ·ç«¯è®¤è¯**ã€‚

> å‹æƒ…æç¤ºï¼šè¿™é‡Œè‰¿è‰¿å·æ‡’äº†ï¼Œå…¶å®**å•ç‹¬**ç»™èµ„æºæœåŠ¡å™¨é…ç½®ä¸€ä¸ª Client çš„ `client-id` å’Œ `client-secret`ã€‚æˆ‘ä»¬å¯ä»¥æŠŠèµ„æºæœåŠ¡å™¨ç†è§£æˆæˆæƒæœåŠ¡å™¨çš„**ä¸€ä¸ªç‰¹æ®Šçš„å®¢æˆ·ç«¯**ã€‚

â‘¡ `security.oauth2.resource` é…ç½®é¡¹ï¼ŒOAuth2 Resource é…ç½®ï¼Œå¯¹åº” [ResourceServerProperties](https://github.com/spring-projects/spring-security-oauth2-boot/blob/master/spring-security-oauth2-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/security/oauth2/resource/ResourceServerProperties.java) ç±»ã€‚

è¿™é‡Œï¼Œæˆ‘ä»¬é€šè¿‡ `token-info-uri` é…ç½®é¡¹ï¼Œè®¾ç½®ä½¿ç”¨æˆæƒæœåŠ¡å™¨çš„ `/oauth/check_token` æ¥å£ï¼Œæ ¡éªŒè®¿é—®ä»¤ç‰Œçš„æœ‰æ•ˆæ€§ã€‚

â‘¢ `security.access-token-uri` é…ç½®é¡¹ï¼Œæ˜¯**æˆ‘ä»¬è‡ªå®šä¹‰**çš„ï¼Œè®¾ç½®æˆæƒæœåŠ¡å™¨çš„ `oauth/token` æ¥å£ï¼Œè·å–è®¿é—®ä»¤ç‰Œã€‚å› ä¸ºç¨åæˆ‘ä»¬å°†åœ¨ [LoginController](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/src/main/java/cn/iocoder/springboot/lab68/resourceserverdemo/controller/LoginController.java) ä¸­ï¼Œå®ç°ä¸€ä¸ª `/login` ç™»å½•æ¥å£ã€‚

### 2.2.3 OAuth2ResourceServerConfig

åˆ›å»º [OAuth2ResourceServerConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/src/main/java/cn/iocoder/springboot/lab68/resourceserverdemo/config/OAuth2ResourceServerConfig.java) ç±»ï¼Œè¿›è¡Œ**èµ„æº**æœåŠ¡å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@Configuration
@EnableResourceServer
public class OAuth2ResourceServerConfig extends ResourceServerConfigurerAdapter {

    @Override
    public void configure(HttpSecurity http) throws Exception {
        http.authorizeRequests()
            
            .antMatchers("/login").permitAll()
            
            .anyRequest().authenticated()
            ;
    }

}
```

â‘  åœ¨ç±»ä¸Šæ·»åŠ  [`@EnableResourceServer`](https://github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/config/annotation/web/configuration/EnableResourceServer.java) æ³¨è§£ï¼Œå£°æ˜å¼€å¯ OAuth **èµ„æº**æœåŠ¡å™¨çš„åŠŸèƒ½ã€‚

åŒæ—¶ï¼Œç»§æ‰¿ [ResourceServerConfigurerAdapter](https://github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/config/annotation/web/configuration/ResourceServerConfigurerAdapter.java) ç±»ï¼Œè¿›è¡Œ OAuth **èµ„æº**æœåŠ¡å™¨çš„é…ç½®ã€‚

â‘¡ `#configure(HttpSecurity http)` æ–¹æ³•ï¼Œè®¾ç½® HTTP æƒé™ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬è®¾ç½® `/login` æ¥å£**æ— éœ€**æƒé™è®¿é—®ï¼Œå…¶å®ƒæ¥å£**è®¤è¯**åå¯è®¿é—®ã€‚

è¿™æ ·ï¼Œå®¢æˆ·ç«¯åœ¨è®¿é—®èµ„æºæœåŠ¡å™¨æ—¶ï¼Œå…¶è¯·æ±‚ä¸­çš„**è®¿é—®ä»¤ç‰Œ**ä¼šè¢«**èµ„æº**æœåŠ¡å™¨è°ƒç”¨**æˆæƒ**æœåŠ¡å™¨çš„ `/oauth/check_token` æ¥å£ï¼Œè¿›è¡Œæ ¡éªŒè®¿é—®ä»¤ç‰Œçš„æ­£ç¡®æ€§ã€‚

### 2.2.4 ExampleController

åˆ›å»º [ExampleController](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/src/main/java/cn/iocoder/springboot/lab68/resourceserverdemo/controller/ExampleController.java) ç±»ï¼Œæä¾› `/api/example/hello` æ¥å£ï¼Œè¡¨ç¤ºä¸€ä¸ªèµ„æºã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@RestController
@RequestMapping("/api/example")
public class ExampleController {

    @RequestMapping("/hello")
    public String hello() {
        return "world";
    }

}
```

### 2.2.5 ResourceServerApplication

åˆ›å»º [ResourceServerApplication](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/src/main/java/cn/iocoder/springboot/lab68/resourceserverdemo/ResourceServerApplication.java) ç±»ï¼Œèµ„æºæœåŠ¡å™¨çš„å¯åŠ¨ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@SpringBootApplication
public class ResourceServerApplication {

    public static void main(String[] args) {
        SpringApplication.run(ResourceServerApplication.class, args);
    }

}
```

### 2.2.6 ç®€å•æµ‹è¯•ï¼ˆç¬¬ä¸€å¼¹ï¼‰

æ‰§è¡Œ ResourceServerApplication å¯åŠ¨èµ„æºæœåŠ¡å™¨ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥è¯·æ±‚æœåŠ¡å™¨çš„ <127.0.0.1:9090/api/example/hello> æ¥å£ï¼Œè¿›è¡Œç›¸åº”çš„æµ‹è¯•ã€‚

â‘  é¦–å…ˆï¼Œè¯·æ±‚ <127.0.0.1:9090/api/example/hello> æ¥å£ï¼Œ**ä¸å¸¦**è®¿é—®ä»¤ç‰Œï¼Œåˆ™è¯·æ±‚ä¼šè¢«**æ‹¦æˆª**ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/09.png)

â‘¡ ç„¶åï¼Œè¯·æ±‚ <127.0.0.1:9090/api/example/hello> æ¥å£ï¼Œå¸¦ä¸Š**é”™è¯¯**çš„è®¿é—®ä»¤ç‰Œï¼Œåˆ™è¯·æ±‚ä¼šè¢«**æ‹¦æˆª**ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/10.png)

> å‹æƒ…æç¤ºï¼šè®¿é—®ä»¤ç‰Œéœ€è¦åœ¨è¯·æ±‚å¤´ `"Authorization"` ä¸Šè®¾ç½®ï¼Œå¹¶ä¸”ä»¥ `"Bearer "` å¼€å¤´ã€‚

â‘¢ æœ€åï¼Œè¯·æ±‚ <127.0.0.1:9090/api/example/hello> æ¥å£ï¼Œå¸¦ä¸Š**æ­£ç¡®**çš„è®¿é—®ä»¤ç‰Œï¼Œåˆ™è¯·æ±‚ä¼šè¢«**é€šè¿‡**ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/11.png)

### 2.2.7 LoginController

åˆ›å»º [LoginController](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/src/main/java/cn/iocoder/springboot/lab68/resourceserverdemo/controller/LoginController.java) ç±»ï¼Œæä¾› `/login` ç™»å½•æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@RestController
@RequestMapping("/")
public class LoginController {

    @Autowired
    private OAuth2ClientProperties oauth2ClientProperties;

    @Value("${security.oauth2.access-token-uri}")
    private String accessTokenUri;

    @PostMapping("/login")
    public OAuth2AccessToken login(@RequestParam("username") String username,
                                   @RequestParam("password") String password) {
        
        ResourceOwnerPasswordResourceDetails resourceDetails = new ResourceOwnerPasswordResourceDetails();
        resourceDetails.setAccessTokenUri(accessTokenUri);
        resourceDetails.setClientId(oauth2ClientProperties.getClientId());
        resourceDetails.setClientSecret(oauth2ClientProperties.getClientSecret());
        resourceDetails.setUsername(username);
        resourceDetails.setPassword(password);
        
        OAuth2RestTemplate restTemplate = new OAuth2RestTemplate(resourceDetails);
        restTemplate.setAccessTokenProvider(new ResourceOwnerPasswordAccessTokenProvider());
        
        return restTemplate.getAccessToken();
    }

}
```

åœ¨ `/login` æ¥å£ä¸­ï¼Œ**èµ„æº**æœåŠ¡å™¨æ‰®æ¼”çš„æ˜¯ä¸€ä¸ª OAuth **å®¢æˆ·ç«¯**çš„è§’è‰²ï¼Œè°ƒç”¨æˆæƒæœåŠ¡å™¨çš„ `/oauth/token` æ¥å£ï¼Œä½¿ç”¨**å¯†ç æ¨¡å¼**è¿›è¡Œæˆæƒï¼Œè·å¾—**è®¿é—®ä»¤ç‰Œ**ã€‚

â‘  `<1>` å¤„ï¼Œåˆ›å»º [ResourceOwnerPasswordResourceDetails](https://github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/client/token/grant/password/ResourceOwnerPasswordResourceDetails.java) å¯¹è±¡ï¼Œå¡«å†™**å¯†ç æ¨¡å¼**æˆæƒéœ€è¦çš„**è¯·æ±‚**å‚æ•°ã€‚

â‘¡ `<2>` å¤„ï¼Œåˆ›å»º [OAuth2RestTemplate](https://github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/client/OAuth2RestTemplate.java) å¯¹è±¡ï¼Œå®ƒæ˜¯ Spring Security OAuth å°è£…çš„å·¥å…·ç±»ï¼Œç”¨äºè¯·æ±‚**æˆæƒ**æœåŠ¡å™¨ã€‚

åŒæ—¶ï¼Œå°† [ResourceOwnerPasswordAccessTokenProvider](https://github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/client/token/grant/password/ResourceOwnerPasswordAccessTokenProvider.java) è®¾ç½®åˆ°å…¶ä¸­ï¼Œè¡¨ç¤ºä½¿ç”¨**å¯†ç æ¨¡å¼**æˆæƒã€‚

> å‹æƒ…æç¤ºï¼šè¿™ä¸€æ­¥éå¸¸é‡è¦ï¼Œè‰¿è‰¿åœ¨è¿™é‡Œå¡äº†éå¸¸éå¸¸éå¸¸ä¹…ï¼Œä¸€åº¦è‡ªé—­è¦æ”¾å¼ƒã€‚

â‘¢ `<3>` å¤„ï¼Œè°ƒç”¨ OAuth2RestTemplate çš„ `#getAccessToken()` æ–¹æ³•ï¼Œè°ƒç”¨æˆæƒæœåŠ¡å™¨çš„ `/oauth/token` æ¥å£ï¼Œè¿›è¡Œ**å¯†ç **æ¨¡å¼çš„æˆæƒã€‚

æ³¨æ„ï¼ŒOAuth2RestTemplate æ˜¯**æœ‰çŠ¶æ€**çš„å·¥å…·ç±»ï¼Œæ‰€ä»¥éœ€è¦æ¯æ¬¡éƒ½**é‡æ–°**åˆ›å»ºã€‚

### 2.2.8 ç®€å•æµ‹è¯•ï¼ˆç¬¬äºŒå¼¹ï¼‰

é‡æ–°æ‰§è¡Œ ResourceServerApplication å¯åŠ¨èµ„æºæœåŠ¡å™¨ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥è¿›è¡Œ `/login` æ¥å£çš„æµ‹è¯•ã€‚

â‘  é¦–å…ˆï¼Œè¯·æ±‚ [http://127.0.0.1:9090/login](http://127.0.0.1:9090/login) æ¥å£ï¼Œä½¿ç”¨**ç”¨æˆ·**çš„**ç”¨æˆ·å**ä¸**å¯†ç **è¿›è¡Œç™»å½•ï¼Œè·å¾—è®¿é—®ä»¤ç‰Œã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/12.png)

å“åº”ç»“æœå’ŒæˆæƒæœåŠ¡å™¨çš„ `/oauth/token` æ¥å£æ˜¯ä¸€è‡´çš„ï¼Œå› ä¸ºå°±æ˜¯è°ƒç”¨å®ƒï¼Œå˜¿å˜¿~

â‘¡ ç„¶åï¼Œè¯·æ±‚ <127.0.0.1:9090/api/example/hello> æ¥å£ï¼Œå¸¦**åˆšåˆšçš„**è®¿é—®ä»¤ç‰Œï¼Œåˆ™è¯·æ±‚ä¼šè¢«é€šè¿‡ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/13.png)

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š
> 
> *   æˆæƒæœåŠ¡å™¨ï¼š[`lab-68-demo02-authorization-server-with-resource-owner-password-credentials`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-authorization-server-with-resource-owner-password-credentials/)
> *   èµ„æºæœåŠ¡å™¨ï¼š[`lab-68-demo02-resource-server`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/)

æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬æ¥å­¦ä¹ **æˆæƒç æ¨¡å¼ï¼ˆAuthorization Codeï¼‰**ã€‚

æˆæƒç æ¨¡å¼ï¼Œæ˜¯åŠŸèƒ½æœ€å®Œæ•´ã€æµç¨‹æœ€ä¸¥å¯†çš„æˆæƒæ¨¡å¼ã€‚å®ƒçš„ç‰¹ç‚¹å°±æ˜¯é€šè¿‡å®¢æˆ·ç«¯çš„**åå°**æœåŠ¡å™¨ï¼Œä¸**æˆæƒ**åŠ¡å™¨è¿›è¡Œäº’åŠ¨ã€‚

> æ—ç™½å›ï¼šä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ**åœ¨æœ‰å®¢æˆ·ç«¯**çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸ç¬¬ä¸‰æ–¹å¹³å°å¸¸å¸¸é‡‡ç”¨è¿™ç§æ–¹å¼ã€‚

![](https://static.iocoder.cn/8a16a81fbba3d6ba1002921bf6b4feff.jpg)

> *   ï¼ˆAï¼‰ç”¨æˆ·è®¿é—®å®¢æˆ·ç«¯ï¼Œåè€…å°†å‰è€…è·³è½¬åˆ°åˆ°**æˆæƒ**æœåŠ¡å™¨ã€‚
> *   ï¼ˆBï¼‰ç”¨æˆ·é€‰æ‹©æ˜¯å¦ç»™äºˆå®¢æˆ·ç«¯æˆæƒã€‚
> *   ï¼ˆCï¼‰å‡è®¾ç”¨æˆ·ç»™äºˆæˆæƒï¼ŒæˆæƒæœåŠ¡å™¨å°†è·³è½¬åˆ°å®¢æˆ·ç«¯äº‹å…ˆæŒ‡å®šçš„ "é‡å®šå‘ URI"ï¼ˆRedirection URIï¼‰ï¼ŒåŒæ—¶é™„ä¸Šä¸€ä¸ª**æˆæƒç **ã€‚
> *   ï¼ˆDï¼‰å®¢æˆ·ç«¯æ”¶åˆ°æˆæƒç ï¼Œé™„ä¸Šæ—©å…ˆçš„ "é‡å®šå‘ URI"ï¼Œå‘è®¤è¯æœåŠ¡å™¨ç”³è¯·**ä»¤ç‰Œ**ã€‚è¿™ä¸€æ­¥æ˜¯åœ¨å®¢æˆ·ç«¯çš„åå°çš„æœåŠ¡å™¨ä¸Šå®Œæˆçš„ï¼Œå¯¹ç”¨æˆ·ä¸å¯è§ã€‚
> *   ï¼ˆEï¼‰è®¤è¯æœåŠ¡å™¨æ ¸å¯¹äº†**æˆæƒç **å’Œ**é‡å®šå‘ URI**ï¼Œç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯å‘é€**è®¿é—®ä»¤ç‰Œ**ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥æ–°å»ºä¸¤ä¸ªé¡¹ç›®ï¼Œæ­å»ºä¸€ä¸ªæˆæƒç æ¨¡å¼çš„ä½¿ç”¨ç¤ºä¾‹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/21.png)

*   [`lab-68-demo02-authorization-server-with-resource-owner-password-credentials`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-authorization-server-with-resource-owner-password-credentials/)ï¼šæˆæƒæœåŠ¡å™¨ã€‚
*   [`lab-68-demo02-resource-server`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/)ï¼šèµ„æºæœåŠ¡å™¨ã€‚

3.1 æ­å»ºæˆæƒæœåŠ¡å™¨
-----------

å¤åˆ¶å‡º [`lab-68-demo02-authorization-server-with-resource-owner-password-credentials`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-authorization-server-with-resource-owner-password-credentials/) é¡¹ç›®ï¼Œ**ä¿®æ”¹**æ­å»ºæˆæƒæœåŠ¡å™¨ã€‚æ”¹åŠ¨ç‚¹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/22.png)

ä»…ä»…éœ€è¦ä¿®æ”¹ [OAuth2AuthorizationServerConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-authorization-server-with-authorization-code/src/main/java/cn/iocoder/springboot/lab68/authorizationserverdemo/config/OAuth2AuthorizationServerConfig.java) ç±»ï¼Œè®¾ç½®ä½¿ç”¨ `"authorization_code"` æˆæƒç æ¨¡å¼ï¼Œå¹¶è®¾ç½®å›è°ƒåœ°å€ã€‚

ğŸ™‚ æ³¨æ„ï¼Œè¿™é‡Œè®¾ç½®çš„å›è°ƒåœ°å€ï¼Œç¨åæˆ‘ä»¬ä¼šåœ¨[ã€Œ3.2 æ­å»ºèµ„æºæœåŠ¡å™¨ã€](#)ä¸­å®ç°ã€‚

### 3.1.1 ç®€å•æµ‹è¯•

æ‰§è¡Œ AuthorizationServerApplication å¯åŠ¨æˆæƒæœåŠ¡å™¨ã€‚

â‘  ä½¿ç”¨**æµè§ˆå™¨**ï¼Œè®¿é—® [http://127.0.0.1:8080/oauth/authorize?client_id=clientapp&redirect_uri=http://127.0.0.1:9090/callback&response_type=code&scope=read_userinfo](http://127.0.0.1:8080/oauth/authorize?client_id=clientapp&redirect_uri=http://127.0.0.1:9090/callback&response_type=code&scope=read_userinfo) åœ°å€ï¼Œè·å–**æˆæƒ**ã€‚è¯·æ±‚å‚æ•°è¯´æ˜å¦‚ä¸‹ï¼š

*   `client_id` å‚æ•°ï¼Œ**å¿…ä¼ **ï¼Œä¸ºæˆ‘ä»¬åœ¨ OAuth2AuthorizationServer ä¸­é…ç½®çš„ Client çš„ç¼–å·ã€‚
*   `redirect_uri` å‚æ•°ï¼Œ**å¯é€‰**ï¼Œå›è°ƒåœ°å€ã€‚å½“ç„¶ï¼Œå¦‚æœ `client_id` å¯¹åº”çš„ Client æœªé…ç½® `redirectUris` å±æ€§ï¼Œä¼šæŠ¥é”™ã€‚
*   `response_type` å‚æ•°ï¼Œ**å¿…ä¼ **ï¼Œè¿”å›ç»“æœä¸º `code` **æˆæƒç **ã€‚
*   `scope` å‚æ•°ï¼Œ**å¯é€‰**ï¼Œç”³è¯·æˆæƒçš„ Scope ã€‚å¦‚æœå¤šä¸ªï¼Œä½¿ç”¨é€—å·åˆ†éš”ã€‚
*   `state` å‚æ•°ï¼Œ**å¯é€‰**ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯çš„å½“å‰çŠ¶æ€ï¼Œå¯ä»¥æŒ‡å®šä»»æ„å€¼ï¼ŒæˆæƒæœåŠ¡å™¨ä¼šåŸå°ä¸åŠ¨åœ°è¿”å›è¿™ä¸ªå€¼ã€‚

> å‹æƒ…æç¤ºï¼š`state` å‚æ•°ï¼Œæœªåœ¨ä¸Šè¿° URL ä¸­ä½“ç°å‡ºæ¥ã€‚

å› ä¸ºæˆ‘ä»¬å¹¶æœª**ç™»å½•**æˆæƒæœåŠ¡å™¨ï¼Œæ‰€ä»¥è¢«æ‹¦æˆªè·³è½¬åˆ°ç™»å½•ç•Œé¢ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/23.png)

â‘¡ è¾“å…¥ç”¨æˆ·çš„è´¦å·å¯†ç ã€Œyunai/1024ã€è¿›è¡Œç™»å½•ã€‚ç™»å½•å®Œæˆåï¼Œè¿›å…¥æˆæƒç•Œé¢ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

> æ—ç™½å›ï¼šå’Œæˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨çš„è…¾è®¯ QQã€å¾®ä¿¡ã€å¾®åšç­‰ç­‰ä¸‰æ–¹ç™»å½•ï¼Œæ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œé™¤äº†ä¸‘äº†ç‚¹ï¼Œå˜¿å˜¿~

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/24.png)

â‘¢ é€‰æ‹© `scope.read_userinfo` ä¸º Approve å…è®¸ï¼Œç‚¹å‡»ã€ŒAuthorizeã€æŒ‰é’®ï¼Œå®Œæˆ**æˆæƒ**æ“ä½œã€‚æµè§ˆå™¨è‡ªåŠ¨é‡å®šå‘åˆ° Redirection URI åœ°å€ï¼Œå¹¶ä¸”åœ¨ URI ä¸Šå¯ä»¥çœ‹åˆ° `code` æˆæƒç ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/25.png)

> å‹æƒ…æç¤ºï¼š`/oauth/authorize` å¯¹åº” [AuthorizationEndpoint](https://github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/provider/endpoint/AuthorizationEndpoint.java) ç«¯ç‚¹ã€‚

â‘£ å› ä¸ºæˆ‘ä»¬æš‚æ—¶æ²¡æœ‰å¯åŠ¨**èµ„æº**æœåŠ¡å™¨ï¼Œæ‰€ä»¥æ˜¾ç¤ºæ— æ³•è®¿é—®ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å…ˆä½¿ç”¨ Postman æ¨¡æ‹Ÿè¯·æ±‚ [http://localhost:8080/oauth/token](http://localhost:8080/oauth/token) åœ°å€ï¼Œä½¿ç”¨**æˆæƒç **è·å–åˆ°**è®¿é—®ä»¤ç‰Œ**ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

è¯·æ±‚è¯´æ˜ï¼š

*   é€šè¿‡ [Basic Auth](https://en.wikipedia.org/wiki/Basic_access_authentication) çš„æ–¹å¼ï¼Œå¡«å†™ `client-id` + `client-secret` ä½œä¸ºç”¨æˆ·åä¸å¯†ç ï¼Œå®ç° Client å®¢æˆ·ç«¯æœ‰æ•ˆæ€§çš„è®¤è¯ã€‚
*   è¯·æ±‚å‚æ•° `grant_type` ä¸º `"authorization_code"`ï¼Œè¡¨ç¤ºä½¿ç”¨**æˆæƒç æ¨¡å¼**ã€‚
*   è¯·æ±‚å‚æ•° `code`ï¼Œä»æˆæƒæœåŠ¡å™¨è·å–åˆ°çš„**æˆæƒç **ã€‚
*   è¯·æ±‚å‚æ•° `redirect_uri`ï¼ŒClient å®¢æˆ·ç«¯çš„ **Redirection URI** åœ°å€ã€‚

æ³¨æ„ï¼Œæˆæƒç **ä»…èƒ½ä½¿ç”¨ä¸€æ¬¡**ï¼Œé‡å¤è¯·æ±‚ä¼šæŠ¥ `Invalid authorization code:` é”™è¯¯ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/27.png)

3.2 æ­å»ºèµ„æºæœåŠ¡å™¨
-----------

å¤ç”¨ [`lab-68-demo02-resource-server`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/) é¡¹ç›®ï¼Œä¸»è¦æ˜¯æä¾›å›è°ƒåœ°å€ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/28.png)

â‘  æ–°å»º [CallbackController](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/src/main/java/cn/iocoder/springboot/lab68/resourceserverdemo/controller/CallbackController.java) ç±»ï¼Œæä¾› `/callback` å›è°ƒåœ°å€ã€‚

â‘¡ åœ¨ [OAuth2ResourceServerConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/src/main/java/cn/iocoder/springboot/lab68/resourceserverdemo/config/OAuth2ResourceServerConfig.java) é…ç½®ç±»ä¸­ï¼Œè®¾ç½® `/callback` å›è°ƒåœ°å€æ— éœ€æƒé™éªŒè¯ï¼Œä¸ç„¶å›è°ƒéƒ½è·³è½¬ä¸è¿‡æ¥å“ˆã€‚

### 3.2.1 CallbackController

åˆ›å»º [CallbackController](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/src/main/java/cn/iocoder/springboot/lab68/resourceserverdemo/controller/CallbackController.java) ç±»ï¼Œæä¾› `/callback` å›è°ƒåœ°å€ï¼Œåœ¨è·å–åˆ°**æˆæƒç **æ—¶ï¼Œè¯·æ±‚**æˆæƒ**æœåŠ¡å™¨ï¼Œé€šè¿‡**æˆæƒç **è·å–**è®¿é—®ä»¤ç‰Œ**ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@RestController
@RequestMapping("/")
public class CallbackController {

    @Autowired
    private OAuth2ClientProperties oauth2ClientProperties;

    @Value("${security.oauth2.access-token-uri}")
    private String accessTokenUri;

    @GetMapping("/callback")
    public OAuth2AccessToken login(@RequestParam("code") String code) {
        
        AuthorizationCodeResourceDetails resourceDetails = new AuthorizationCodeResourceDetails();
        resourceDetails.setAccessTokenUri(accessTokenUri);
        resourceDetails.setClientId(oauth2ClientProperties.getClientId());
        resourceDetails.setClientSecret(oauth2ClientProperties.getClientSecret());
        
        OAuth2RestTemplate restTemplate = new OAuth2RestTemplate(resourceDetails);
        restTemplate.getOAuth2ClientContext().getAccessTokenRequest().setAuthorizationCode(code); 
        restTemplate.getOAuth2ClientContext().getAccessTokenRequest().setPreservedState("http://127.0.0.1:9090/callback"); 
        restTemplate.setAccessTokenProvider(new AuthorizationCodeAccessTokenProvider());
        
        return restTemplate.getAccessToken();
    }

}
```

ä»£ç æ¯”è¾ƒç®€å•ï¼Œè¿˜æ˜¯ä½¿ç”¨ OAuth2RestTemplate è¿›è¡Œè¯·æ±‚æˆæƒæœåŠ¡å™¨ï¼Œèƒ–å‹è‡ªå·±ç…ç…å“ˆã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ `<1>` å’Œ `<2>` å¤„ï¼Œè®¾ç½®è¯·æ±‚æˆæƒæœåŠ¡å™¨éœ€è¦çš„ `code` å’Œ `redirect_uri` å‚æ•°ã€‚

### 3.2.2 ç®€å•æµ‹è¯•

æ‰§è¡Œ ResourceServerApplication å¯åŠ¨èµ„æºæœåŠ¡å™¨ã€‚

é‡å¤[ã€Œ3.2.1 ç®€å•æµ‹è¯•ã€](#)çš„è¿‡ç¨‹ï¼ŒæˆåŠŸè·å–åˆ°**è®¿é—®ä»¤ç‰Œ**ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/29.png)

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š
> 
> *   æˆæƒæœåŠ¡å™¨ï¼š[`lab-68-demo02-authorization-server-with-implicit`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-authorization-server-with-implicit/)
> *   èµ„æºæœåŠ¡å™¨ï¼š[`lab-68-demo02-resource-server`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/)

æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬æ¥å­¦ä¹ **ç®€åŒ–æ¨¡å¼ï¼ˆImplicitï¼‰**ã€‚

ç®€åŒ–æ¨¡å¼ï¼Œä¸é€šè¿‡ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºçš„æœåŠ¡å™¨ï¼Œç›´æ¥åœ¨æµè§ˆå™¨ä¸­å‘**æˆæƒ**æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œï¼Œ**è·³è¿‡**äº† â€œæˆæƒç â€ è¿™ä¸ªæ­¥éª¤ï¼Œå› æ­¤å¾—åã€‚æ‰€æœ‰æ­¥éª¤åœ¨æµè§ˆå™¨ä¸­å®Œæˆï¼Œä»¤ç‰Œå¯¹è®¿é—®è€…æ˜¯**å¯è§**çš„ï¼Œä¸”å®¢æˆ·ç«¯ä¸éœ€è¦æˆæƒã€‚

![](https://static.iocoder.cn/202e8e80d8b1740f38bde7a3d889e088.jpg)

> *   ï¼ˆAï¼‰ç”¨æˆ·è®¿é—®å®¢æˆ·ç«¯ï¼Œåè€…å°†å‰è€…è·³è½¬åˆ°åˆ°**æˆæƒ**æœåŠ¡å™¨ã€‚
> *   ï¼ˆBï¼‰ç”¨æˆ·é€‰æ‹©æ˜¯å¦ç»™äºˆå®¢æˆ·ç«¯æˆæƒã€‚
> *   ï¼ˆCï¼‰å‡è®¾ç”¨æˆ·ç»™äºˆæˆæƒï¼ŒæˆæƒæœåŠ¡å™¨å°†ç”¨æˆ·å¯¼å‘å®¢æˆ·ç«¯æŒ‡å®šçš„ "é‡å®šå‘ URI"ï¼Œå¹¶åœ¨ URI çš„ **Hash éƒ¨åˆ†**åŒ…å«äº†**è®¿é—®ä»¤ç‰Œ**ã€‚
> *   ï¼ˆDï¼‰æµè§ˆå™¨å‘èµ„æºæœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå…¶ä¸­ä¸åŒ…æ‹¬ä¸Šä¸€æ­¥æ”¶åˆ°çš„ Hash å€¼ã€‚
> *   ï¼ˆEï¼‰èµ„æºæœåŠ¡å™¨è¿”å›ä¸€ä¸ªç½‘é¡µï¼Œå…¶ä¸­åŒ…å«çš„ä»£ç å¯ä»¥è·å– Hash å€¼ä¸­çš„ä»¤ç‰Œã€‚
> *   ï¼ˆFï¼‰æµè§ˆå™¨æ‰§è¡Œä¸Šä¸€æ­¥è·å¾—çš„è„šæœ¬ï¼Œæå–å‡ºä»¤ç‰Œã€‚
> *   ï¼ˆGï¼‰æµè§ˆå™¨å°†ä»¤ç‰Œå‘ç»™å®¢æˆ·ç«¯ã€‚

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/31.png)

*   [`lab-68-demo02-authorization-server-with-implicit`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-authorization-server-with-implicit/)ï¼šæˆæƒæœåŠ¡å™¨ã€‚
*   [`lab-68-demo02-resource-server`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/)ï¼šèµ„æºæœåŠ¡å™¨ã€‚

4.1 æ­å»ºæˆæƒæœåŠ¡å™¨
-----------

å¤åˆ¶å‡º [`lab-68-demo02-authorization-server-with-implicit`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-authorization-server-with-implicit/) é¡¹ç›®ï¼Œ**ä¿®æ”¹**æ­å»ºæˆæƒæœåŠ¡å™¨ã€‚æ”¹åŠ¨ç‚¹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/32.png)

ä»…ä»…éœ€è¦ä¿®æ”¹ [OAuth2AuthorizationServerConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-authorization-server-with-implicit/src/main/java/cn/iocoder/springboot/lab68/authorizationserverdemo/config/OAuth2AuthorizationServerConfig.java) ç±»ï¼Œè®¾ç½®ä½¿ç”¨ `"implicit"` ç®€åŒ–æ¨¡å¼ï¼Œå¹¶è®¾ç½®å›è°ƒåœ°å€ã€‚

ğŸ™‚ æ³¨æ„ï¼Œè¿™é‡Œè®¾ç½®çš„å›è°ƒåœ°å€ï¼Œç¨åæˆ‘ä»¬ä¼šåœ¨[ã€Œ4.2 æ­å»ºèµ„æºæœåŠ¡å™¨ã€](#)ä¸­å®ç°ã€‚

4.2 æ­å»ºèµ„æºæœåŠ¡å™¨
-----------

å¤ç”¨ [`lab-68-demo02-resource-server`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/) é¡¹ç›®ï¼Œä¸»è¦æ˜¯æä¾›å›è°ƒåœ°å€ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/33.png)

â‘  æ–°å»º [Callback02Controller](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/src/main/java/cn/iocoder/springboot/lab68/resourceserverdemo/controller/Callback02Controller.java) ç±»ï¼Œæä¾› `/callback02` å›è°ƒåœ°å€ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@RestController
@RequestMapping("/")
public class Callback02Controller {

    @GetMapping("/callback02")
    public String login() {
        return "å‡è£…è¿™é‡Œæœ‰ä¸€ä¸ªé¡µé¢";
    }

}
```

> å‹æƒ…æç¤ºï¼šè€ƒè™‘åˆ°æš‚æ—¶ä¸æƒ³åšé¡µé¢ï¼Œæ‰€ä»¥è¿™é‡Œå…ˆå‡è£…ä¸€ä¸‹ï¼Œå˜¿å˜¿ã€‚

â‘¡ åœ¨ [OAuth2ResourceServerConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/src/main/java/cn/iocoder/springboot/lab68/resourceserverdemo/config/OAuth2ResourceServerConfig.java) é…ç½®ç±»ä¸­ï¼Œè®¾ç½® `/callback02` å›è°ƒåœ°å€æ— éœ€æƒé™éªŒè¯ï¼Œä¸ç„¶å›è°ƒéƒ½è·³è½¬ä¸è¿‡æ¥å“ˆã€‚

4.3 ç®€å•æµ‹è¯•
--------

æ‰§è¡Œ AuthorizationServerApplication å¯åŠ¨æˆæƒæœåŠ¡å™¨ã€‚  
æ‰§è¡Œ ResourceServerApplication å¯åŠ¨èµ„æºæœåŠ¡å™¨ã€‚

â‘  ä½¿ç”¨**æµè§ˆå™¨**ï¼Œè®¿é—® [http://127.0.0.1:8080/oauth/authorize?client_id=clientapp&redirect_uri=http://127.0.0.1:9090/callback02&response_type=token&scope=read_userinfo](http://127.0.0.1:8080/oauth/authorize?client_id=clientapp&redirect_uri=http://127.0.0.1:9090/callback02&response_type=token&scope=read_userinfo) åœ°å€ï¼Œè·å–**æˆæƒ**ã€‚è¯·æ±‚å‚æ•°è¯´æ˜å¦‚ä¸‹ï¼š

*   `client_id` å‚æ•°ï¼Œ**å¿…ä¼ **ï¼Œä¸ºæˆ‘ä»¬åœ¨ OAuth2AuthorizationServer ä¸­é…ç½®çš„ Client çš„ç¼–å·ã€‚
*   `redirect_uri` å‚æ•°ï¼Œ**å¯é€‰**ï¼Œå›è°ƒåœ°å€ã€‚å½“ç„¶ï¼Œå¦‚æœ `client_id` å¯¹åº”çš„ Client æœªé…ç½® `redirectUris` å±æ€§ï¼Œä¼šæŠ¥é”™ã€‚
*   `response_type` å‚æ•°ï¼Œ**å¿…ä¼ **ï¼Œè¿”å›ç»“æœä¸º `token` **è®¿é—®ä»¤ç‰Œ**ã€‚
*   `scope` å‚æ•°ï¼Œ**å¯é€‰**ï¼Œç”³è¯·æˆæƒçš„ Scope ã€‚å¦‚æœå¤šä¸ªï¼Œä½¿ç”¨é€—å·åˆ†éš”ã€‚
*   `state` å‚æ•°ï¼Œ**å¯é€‰**ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯çš„å½“å‰çŠ¶æ€ï¼Œå¯ä»¥æŒ‡å®šä»»æ„å€¼ï¼ŒæˆæƒæœåŠ¡å™¨ä¼šåŸå°ä¸åŠ¨åœ°è¿”å›è¿™ä¸ªå€¼ã€‚

> å‹æƒ…æç¤ºï¼š`state` å‚æ•°ï¼Œæœªåœ¨ä¸Šè¿° URL ä¸­ä½“ç°å‡ºæ¥ã€‚

å› ä¸ºæˆ‘ä»¬å¹¶æœª**ç™»å½•**æˆæƒæœåŠ¡å™¨ï¼Œæ‰€ä»¥è¢«æ‹¦æˆªè·³è½¬åˆ°ç™»å½•ç•Œé¢ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/23.png)

â‘¡ è¾“å…¥ç”¨æˆ·çš„è´¦å·å¯†ç ã€Œyunai/1024ã€è¿›è¡Œç™»å½•ã€‚ç™»å½•å®Œæˆåï¼Œè¿›å…¥æˆæƒç•Œé¢ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

> æ—ç™½å›ï¼šå’Œæˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨çš„è…¾è®¯ QQã€å¾®ä¿¡ã€å¾®åšç­‰ç­‰ä¸‰æ–¹ç™»å½•ï¼Œæ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œé™¤äº†ä¸‘äº†ç‚¹ï¼Œå˜¿å˜¿~

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/34.png)

â‘¢ é€‰æ‹© `scope.read_userinfo` ä¸º Approve å…è®¸ï¼Œç‚¹å‡»ã€ŒAuthorizeã€æŒ‰é’®ï¼Œå®Œæˆ**æˆæƒ**æ“ä½œã€‚æµè§ˆå™¨è‡ªåŠ¨é‡å®šå‘åˆ° Redirection URI åœ°å€ï¼Œå¹¶ä¸”åœ¨ URI ä¸Šçš„ **Hash éƒ¨åˆ†**å¯ä»¥çœ‹åˆ° `access_token` è®¿é—®ä»¤ç‰Œã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/35.png)

åç»­ï¼Œå¯ä»¥é€šè¿‡ç¼–å†™ Javascript è„šæœ¬çš„ä»£ç ï¼Œè·å– URI ä¸Šçš„ **Hash éƒ¨åˆ†**çš„è®¿é—®ä»¤ç‰Œã€‚

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š
> 
> *   æˆæƒæœåŠ¡å™¨ï¼š[`lab-68-demo02-authorization-server-with-client-credentials`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-authorization-server-with-client-credentials/)
> *   èµ„æºæœåŠ¡å™¨ï¼š[`lab-68-demo02-resource-server`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/)

æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬æ¥å­¦ä¹ **å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆClient Credentialsï¼‰**ã€‚

å®¢æˆ·ç«¯æ¨¡å¼ï¼ŒæŒ‡å®¢æˆ·ç«¯ä»¥è‡ªå·±çš„åä¹‰ï¼Œè€Œä¸æ˜¯ä»¥ç”¨æˆ·çš„åä¹‰ï¼Œå‘æˆæƒæœåŠ¡å™¨è¿›è¡Œè®¤è¯ã€‚

ä¸¥æ ¼åœ°è¯´ï¼Œå®¢æˆ·ç«¯æ¨¡å¼å¹¶ä¸å±äº OAuth æ¡†æ¶æ‰€è¦è§£å†³çš„é—®é¢˜ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œç”¨æˆ·ç›´æ¥å‘å®¢æˆ·ç«¯æ³¨å†Œï¼Œå®¢æˆ·ç«¯ä»¥è‡ªå·±çš„åä¹‰è¦æ±‚æˆæƒæœåŠ¡å™¨æä¾›æœåŠ¡ï¼Œå…¶å®ä¸å­˜åœ¨æˆæƒé—®é¢˜ã€‚

> æ—ç™½å›ï¼šæˆ‘ä»¬å¯¹æ¥å¾®ä¿¡å…¬ä¼—å·æ—¶ï¼Œå°±é‡‡ç”¨çš„å®¢æˆ·ç«¯æ¨¡å¼ã€‚æˆ‘ä»¬çš„åç«¯æœåŠ¡å™¨å°±æ‰®æ¼” â€œå®¢æˆ·ç«¯â€ çš„è§’è‰²ï¼Œä¸å¾®ä¿¡å…¬ä¼—å·çš„åç«¯æœåŠ¡å™¨è¿›è¡Œäº¤äº’ã€‚

![](https://static.iocoder.cn/062fff24b9564ca9e0cbf4f702af9ee6.jpg)

> *   ï¼ˆAï¼‰å®¢æˆ·ç«¯å‘æˆæƒæœåŠ¡å™¨è¿›è¡Œèº«ä»½è®¤è¯ï¼Œå¹¶è¦æ±‚ä¸€ä¸ª**è®¿é—®ä»¤ç‰Œ**ã€‚
> *   ï¼ˆBï¼‰æˆæƒæœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯æä¾›è®¿é—®ä»¤ç‰Œã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥æ–°å»ºä¸¤ä¸ªé¡¹ç›®ï¼Œæ­å»ºä¸€ä¸ªå®¢æˆ·ç«¯æ¨¡å¼çš„ä½¿ç”¨ç¤ºä¾‹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/41.png)

*   [`lab-68-demo02-authorization-server-with-client-credentials`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-authorization-server-with-client-credentials/)ï¼šæˆæƒæœåŠ¡å™¨ã€‚
*   [`lab-68-demo02-resource-server`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/)ï¼šèµ„æºæœåŠ¡å™¨ã€‚

5.1 æ­å»ºæˆæƒæœåŠ¡å™¨
-----------

å¤åˆ¶å‡º [`lab-68-demo02-authorization-server-with-client-credentials`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-authorization-server-with-client-credentials/) é¡¹ç›®ï¼Œ**ä¿®æ”¹**æ­å»ºæˆæƒæœåŠ¡å™¨ã€‚æ”¹åŠ¨ç‚¹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/42.png)

â‘  åˆ é™¤ SecurityConfig é…ç½®ç±»ï¼Œå› ä¸ºå®¢æˆ·ç«¯æ¨¡å¼ä¸‹ï¼Œæ— éœ€ Spring Security æä¾›ç”¨æˆ·çš„è®¤è¯åŠŸèƒ½ã€‚

ä½†æ˜¯ï¼ŒSpring Security OAuth éœ€è¦ä¸€ä¸ª PasswordEncoder Beanï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ [OAuth2AuthorizationServerConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-authorization-server-with-client-credentials/src/main/java/cn/iocoder/springboot/lab68/authorizationserverdemo/config/OAuth2AuthorizationServerConfig.java) ç±»çš„ `#passwordEncoder()` æ–¹æ³•è¿›è¡Œåˆ›å»ºã€‚

â‘¡ ä¿®æ”¹ [OAuth2AuthorizationServerConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-authorization-server-with-implicit/src/main/java/cn/iocoder/springboot/lab68/authorizationserverdemo/config/OAuth2AuthorizationServerConfig.java) ç±»ï¼Œè®¾ç½®ä½¿ç”¨ `"client_credentials"` å®¢æˆ·ç«¯æ¨¡å¼ã€‚

### 5.1.1 ç®€å•æµ‹è¯•

æ‰§è¡Œ AuthorizationServerApplication å¯åŠ¨æˆæƒæœåŠ¡å™¨ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬ä½¿ç”¨ **Postman æ¨¡æ‹Ÿä¸€ä¸ª Client**ã€‚

â‘  `POST` è¯·æ±‚ [http://localhost:8080/oauth/token](http://localhost:8080/oauth/token) åœ°å€ï¼Œä½¿ç”¨å®¢æˆ·ç«¯æ¨¡å¼è¿›è¡Œ**æˆæƒ**ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

è¯·æ±‚è¯´æ˜ï¼š

*   é€šè¿‡ [Basic Auth](https://en.wikipedia.org/wiki/Basic_access_authentication) çš„æ–¹å¼ï¼Œå¡«å†™ `client-id` + `client-secret` ä½œä¸ºç”¨æˆ·åä¸å¯†ç ï¼Œå®ç° Client å®¢æˆ·ç«¯æœ‰æ•ˆæ€§çš„è®¤è¯ã€‚
*   è¯·æ±‚å‚æ•° `grant_type` ä¸º `"client_credentials"`ï¼Œè¡¨ç¤ºä½¿ç”¨**å®¢æˆ·ç«¯æ¨¡å¼**ã€‚

å“åº”å°±æ˜¯è®¿é—®ä»¤ç‰Œï¼Œèƒ–å‹è‡ªå·±ç…ç…å³å¯ã€‚

5.2 æ­å»ºèµ„æºæœåŠ¡å™¨
-----------

å¤ç”¨ [`lab-68-demo02-resource-server`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/) é¡¹ç›®ï¼Œä¿®æ”¹ç‚¹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/44.png)

â‘  æ–°å»º [ClientLoginController](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/src/main/java/cn/iocoder/springboot/lab68/resourceserverdemo/controller/ClientLoginController.java) ç±»ï¼Œæä¾› `/client-login` æ¥å£ï¼Œå®ç°è°ƒç”¨**æˆæƒ**æœåŠ¡å™¨ï¼Œè¿›è¡Œ**å®¢æˆ·ç«¯**æ¨¡å¼çš„æˆæƒï¼Œè·å¾—è®¿é—®ä»¤ç‰Œã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@RestController
@RequestMapping("/")
public class ClientLoginController {

    @Autowired
    private OAuth2ClientProperties oauth2ClientProperties;

    @Value("${security.oauth2.access-token-uri}")
    private String accessTokenUri;

    @PostMapping("/client-login")
    public OAuth2AccessToken login() {
        
        ClientCredentialsResourceDetails resourceDetails = new ClientCredentialsResourceDetails();
        resourceDetails.setAccessTokenUri(accessTokenUri);
        resourceDetails.setClientId(oauth2ClientProperties.getClientId());
        resourceDetails.setClientSecret(oauth2ClientProperties.getClientSecret());
        
        OAuth2RestTemplate restTemplate = new OAuth2RestTemplate(resourceDetails);
        restTemplate.setAccessTokenProvider(new ClientCredentialsAccessTokenProvider());
        
        return restTemplate.getAccessToken();
    }

}
```

ä»£ç æ¯”è¾ƒç®€å•ï¼Œè¿˜æ˜¯ä½¿ç”¨ OAuth2RestTemplate è¿›è¡Œè¯·æ±‚æˆæƒæœåŠ¡å™¨ï¼Œèƒ–å‹è‡ªå·±ç…ç…å“ˆã€‚

â‘¡ åœ¨ [OAuth2ResourceServerConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo02-resource-server/src/main/java/cn/iocoder/springboot/lab68/resourceserverdemo/config/OAuth2ResourceServerConfig.java) é…ç½®ç±»ä¸­ï¼Œè®¾ç½® `/client-login` æ¥å£æ— éœ€æƒé™éªŒè¯ï¼Œä¸ç„¶æ— æ³•è°ƒç”¨å“ˆã€‚

### 5.2.1 ç®€å•æµ‹è¯•

æ‰§è¡Œ ResourceServerApplication å¯åŠ¨èµ„æºæœåŠ¡å™¨ã€‚

â‘  ä½¿ç”¨[ã€Œ5.1.1 ç®€å•æµ‹è¯•ã€](#)å°èŠ‚è·å¾—çš„**è®¿é—®ä»¤ç‰Œ**ï¼Œè¯·æ±‚ <127.0.0.1:9090/api/example/hello> æ¥å£æ—¶**å¸¦ä¸Š**ï¼Œåˆ™è¯·æ±‚ä¼šè¢«**é€šè¿‡**ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/45.png)

â‘¡ è¯·æ±‚ [http://127.0.0.1:9090/clientlogin](http://127.0.0.1:9090/clientlogin) æ¥å£ï¼Œä½¿ç”¨**å®¢æˆ·ç«¯æ¨¡å¼**è¿›è¡Œæˆæƒï¼Œè·å¾—è®¿é—®ä»¤ç‰Œã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/46.png)

å“åº”ç»“æœå’ŒæˆæƒæœåŠ¡å™¨çš„ `/oauth/token` æ¥å£æ˜¯ä¸€è‡´çš„ï¼Œå› ä¸ºå°±æ˜¯è°ƒç”¨å®ƒï¼Œå˜¿å˜¿~

> æ—ç™½å›ï¼šè¿™ä¸ªå°èŠ‚çš„æ ‡é¢˜ï¼Œè‰¿è‰¿æœ‰ç‚¹ä¸çŸ¥é“æ€ä¹ˆå–äº†ï¼Œå°±å…ˆå«åˆå¹¶æœåŠ¡å™¨å§ = =ï¼

åœ¨é¡¹ç›®æ¯”è¾ƒå°æ—¶ï¼Œè€ƒè™‘åˆ°èŠ‚çœæœåŠ¡å™¨èµ„æºï¼Œä¼šè€ƒè™‘å°†**æˆæƒ**æœåŠ¡å™¨å’Œ**èµ„æº**æœåŠ¡å™¨**åˆå¹¶**åˆ°ä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œé¿å…å¯åŠ¨å¤šä¸ª Java è¿›ç¨‹ã€‚è‰¯å¿ƒçš„è‰¿è‰¿ï¼Œç¼–å†™äº†å››ç§æˆæƒæ¨¡å¼çš„ç¤ºä¾‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/51.png)

*   åŸºäº**å¯†ç **æ¨¡å¼çš„ç¤ºä¾‹ï¼š[`lab-68-demo01-resource-owner-password-credentials-server`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo01-resource-owner-password-credentials-server/)
*   åŸºäº**æˆæƒç **æ¨¡å¼çš„ç¤ºä¾‹ï¼š[`lab-68-demo01-authorization-code-server`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo01-authorization-code-server/)
*   åŸºäº**ç®€åŒ–**æ¨¡å¼çš„ç¤ºä¾‹ï¼š[`lab-68-demo01-implicit-server`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo01-implicit-server/)
*   åŸºäº**å®¢æˆ·ç«¯**æ¨¡å¼çš„ç¤ºä¾‹ï¼š[`lab-68-demo01-client-credentials-server`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo01-client-credentials-server/)

å…·ä½“çš„ä»£ç å®ç°ï¼Œå®é™…å’Œä¸Šè¿°æ¯ä¸ªæˆæƒæ¨¡å¼å¯¹åº”çš„å°èŠ‚æ˜¯åŸºæœ¬ä¸€è‡´çš„ï¼Œåªæ˜¯è¯´å°†ä»£ç  â€œ**æ”¾**â€ åœ¨äº†ä¸€ä¸ªé¡¹ç›®ä¸­ã€‚å˜¿å˜¿~

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š
> 
> *   æˆæƒæœåŠ¡å™¨ï¼š[`lab-68-demo03-authorization-server-with-client-credentials`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-68-spring-security-oauth/lab-68-demo03-authorization-server-with-resource-owner-password-credentials)

åœ¨ OAuth2.0 ä¸­ï¼Œä¸€å…±æœ‰**ä¸¤ç±»**ä»¤ç‰Œï¼š

*   **è®¿é—®**ä»¤ç‰Œï¼ˆAccess Tokenï¼‰
*   **åˆ·æ–°**ä»¤ç‰Œï¼ˆRefresh Tokenï¼‰

åœ¨**è®¿é—®**ä»¤ç‰Œè¿‡æœŸæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨**åˆ·æ–°**ä»¤ç‰Œå‘**æˆæƒ**æœåŠ¡å™¨è·å–ä¸€ä¸ª**æ–°**çš„è®¿é—®ä»¤ç‰Œã€‚

å¯èƒ½ä¼šèƒ–å‹æœ‰ç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰**åˆ·æ–°**ä»¤ç‰Œå‘¢ï¼Ÿæ¯æ¬¡è¯·æ±‚èµ„æºæœåŠ¡å™¨æ—¶ï¼Œéƒ½ä¼šåœ¨è¯·æ±‚ä¸Šå¸¦ä¸Š**è®¿é—®**ä»¤ç‰Œï¼Œè¿™æ ·å®ƒçš„æ³„éœ²é£é™©æ˜¯**ç›¸å¯¹**é«˜çš„ã€‚

å› æ­¤ï¼Œå‡ºäº**å®‰å…¨æ€§**çš„è€ƒè™‘ï¼Œè®¿é—®ä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´**æ¯”è¾ƒçŸ­**ï¼Œåˆ·æ–°ä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´**æ¯”è¾ƒé•¿**ã€‚è¿™æ ·ï¼Œå¦‚æœè®¿é—®ä»¤ç‰Œå³ä½¿è¢«ç›—ç”¨èµ°ï¼Œé‚£ä¹ˆåœ¨ä¸€å®šçš„æ—¶é—´åï¼Œè®¿é—®ä»¤ç‰Œä¹Ÿèƒ½åœ¨è¾ƒçŸ­çš„æ—¶é—´å¼è¿‡æœŸã€‚å½“ç„¶ï¼Œå®‰å…¨ä¹Ÿæ˜¯ç›¸å¯¹çš„ï¼Œå¦‚æœä½¿ç”¨åˆ·æ–°ä»¤ç‰Œåï¼Œè·å–åˆ°æ–°çš„è®¿é—®ä»¤ç‰Œï¼Œè®¿é—®ä»¤ç‰Œ**åç»­**åˆ**å¯èƒ½**è¢«ç›—ç”¨ã€‚

è‰¿è‰¿æ•´ç†äº†ä¸‹ï¼Œå¤§å®¶å¸¸ç”¨å¼€æ”¾å¹³å°çš„ä»¤ç‰Œè¿‡æœŸæ—¶é—´ï¼Œè®©å¤§å®¶æ›´å¥½çš„ç†è§£ï¼š

<table><thead><tr><th>å¼€æ”¾å¹³å°</th><th>Access Token æœ‰æ•ˆæœŸ</th><th>Refresh Token æœ‰æ•ˆæœŸ</th></tr></thead><tbody><tr><td><a href="https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&amp;t=resource/res_list&amp;verify=1&amp;id=open1419316505&amp;token=&amp;lang=zh_CN" rel="external nofollow noopener noreferrer" target="_blank">å¾®ä¿¡å¼€æ”¾å¹³å°</a></td><td>2 å°æ—¶</td><td>æœªçŸ¥</td></tr><tr><td><a href="http://wiki.open.qq.com/wiki/website/%E8%8E%B7%E5%8F%96Access_Token" rel="external nofollow noopener noreferrer" target="_blank">è…¾è®¯å¼€æ”¾å¹³å°</a></td><td>90 å¤©</td><td>æœªçŸ¥</td></tr><tr><td><a href="https://dev.mi.com/docs/passport/access-token-life-cycle/" rel="external nofollow noopener noreferrer" target="_blank">å°ç±³å¼€æ”¾å¹³å°</a></td><td>90 å¤©</td><td>10 å¹´</td></tr></tbody></table>

7.1 ç¤ºä¾‹é¡¹ç›®
--------

ä¸‹é¢ï¼Œå¤åˆ¶å‡º [`lab-68-demo03-authorization-server-with-client-credentials`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-68-spring-security-oauth/lab-68-demo03-authorization-server-with-resource-owner-password-credentials) é¡¹ç›®ï¼Œæ­å»º**æä¾›è®¿é—®ä»¤ç‰Œ**çš„**æˆæƒ**æœåŠ¡å™¨ã€‚æ”¹åŠ¨ç‚¹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/61.png)

â‘  åœ¨ [OAuth2AuthorizationServerConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo03-authorization-server-with-resource-owner-password-credentials/src/main/java/cn/iocoder/springboot/lab68/authorizationserverdemo/config/OAuth2AuthorizationServerConfig.java) çš„ `#configure(ClientDetailsServiceConfigurer clients)` æ–¹æ³•ä¸­ï¼Œåœ¨é…ç½®çš„ Client çš„æˆæƒæ¨¡å¼ä¸­ï¼Œé¢å¤–æ–°å¢ `"refresh_token"` åˆ·æ–°ä»¤ç‰Œã€‚

é€šè¿‡ `#accessTokenValiditySeconds(int accessTokenValiditySeconds)` æ–¹æ³•ï¼Œè®¾ç½®**è®¿é—®**ä»¤ç‰Œçš„æœ‰æ•ˆæœŸã€‚  
é€šè¿‡ `#refreshTokenValiditySeconds(int refreshTokenValiditySeconds)` æ–¹æ³•ï¼Œè®¾ç½®**åˆ·æ–°**ä»¤ç‰Œçš„æœ‰æ•ˆæœŸã€‚

â‘¡ åœ¨ [OAuth2AuthorizationServerConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo03-authorization-server-with-resource-owner-password-credentials/src/main/java/cn/iocoder/springboot/lab68/authorizationserverdemo/config/OAuth2AuthorizationServerConfig.java) çš„ `#configure(AuthorizationServerEndpointsConfigurer endpoints)` æ–¹æ³•ä¸­ï¼Œè®¾ç½®ä½¿ç”¨çš„ `userDetailsService` ç”¨æˆ·è¯¦æƒ… Serviceã€‚

è€Œè¯¥ `userDetailsService` æ˜¯åœ¨ [SecurityConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo03-authorization-server-with-resource-owner-password-credentials/src/main/java/cn/iocoder/springboot/lab68/authorizationserverdemo/config/SecurityConfig.java) çš„ `#userDetailsServiceBean()` æ–¹æ³•åˆ›å»ºçš„ UserDetailsService Beanã€‚

> å‹æƒ…æç¤ºï¼šå¦‚æœä¸è¿›è¡Œ UserDetailsService çš„è®¾ç½®ï¼Œåœ¨ä½¿ç”¨**åˆ·æ–°**ä»¤ç‰Œè·å–æ–°çš„**è®¿é—®**ä»¤ç‰Œæ—¶ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚

7.2 ç®€å•æµ‹è¯•
--------

æ‰§è¡Œ AuthorizationServerApplication å¯åŠ¨æˆæƒæœåŠ¡å™¨ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬ä½¿ç”¨ **Postman æ¨¡æ‹Ÿä¸€ä¸ª Client**ã€‚

â‘  `POST` è¯·æ±‚ [http://localhost:8080/oauth/token](http://localhost:8080/oauth/token) åœ°å€ï¼Œä½¿ç”¨**å¯†ç **æ¨¡å¼è¿›è¡Œ**æˆæƒ**ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/62.png)

**é¢å¤–**å¤šè¿”å›äº† `refresh_token` åˆ·æ–°ä»¤ç‰Œã€‚

â‘¡ `POST` è¯·æ±‚ [http://localhost:8080/oauth/token](http://localhost:8080/oauth/token) åœ°å€ï¼Œä½¿ç”¨**åˆ·æ–°ä»¤ç‰Œ**æ¨¡å¼è¿›è¡Œ**æˆæƒ**ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/63.png)

è¯·æ±‚è¯´æ˜ï¼š

*   é€šè¿‡ [Basic Auth](https://en.wikipedia.org/wiki/Basic_access_authentication) çš„æ–¹å¼ï¼Œå¡«å†™ `client-id` + `client-secret` ä½œä¸ºç”¨æˆ·åä¸å¯†ç ï¼Œå®ç° Client å®¢æˆ·ç«¯æœ‰æ•ˆæ€§çš„è®¤è¯ã€‚
*   è¯·æ±‚å‚æ•° `grant_type` ä¸º `"refresh_token"`ï¼Œè¡¨ç¤ºä½¿ç”¨**åˆ·æ–°ä»¤ç‰Œæ¨¡å¼**ã€‚
*   è¯·æ±‚å‚æ•° `refresh_token`ï¼Œè¡¨ç¤º**åˆ·æ–°ä»¤ç‰Œ**ã€‚

åœ¨å“åº”ä¸­ï¼Œè¿”å›äº†**æ–°çš„** `access_token` **è®¿é—®**ä»¤ç‰Œã€‚æ³¨æ„ï¼Œ**è€çš„** `access_token` **è®¿é—®**ä»¤ç‰Œä¼š**å¤±æ•ˆ**ï¼Œæ— æ³•ç»§ç»­ä½¿ç”¨ã€‚

> ç¤ºä¾‹ä»£ç å¯¹åº”ä»“åº“ï¼š
> 
> *   æˆæƒæœåŠ¡å™¨ï¼š[`lab-68-demo03-authorization-server-with-client-credentials`](https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-68-spring-security-oauth/lab-68-demo03-authorization-server-with-resource-owner-password-credentials)

åœ¨ç”¨æˆ·**ç™»å‡º**ç³»ç»Ÿæ—¶ï¼Œæˆ‘ä»¬ä¼šæœ‰**åˆ é™¤**ä»¤ç‰Œçš„éœ€æ±‚ã€‚è™½ç„¶è¯´ï¼Œå¯ä»¥é€šè¿‡å®¢æˆ·ç«¯**æœ¬åœ°**åˆ é™¤ä»¤ç‰Œçš„æ–¹å¼å®ç°ã€‚ä½†æ˜¯ï¼Œè€ƒè™‘åˆ°çœŸæ­£çš„å½»åº•çš„å®ç°åˆ é™¤ä»¤ç‰Œï¼Œå¿…ç„¶æœåŠ¡ç«¯**è‡ªèº«**éœ€è¦åˆ é™¤ä»¤ç‰Œã€‚

> å‹æƒ…æç¤ºï¼šå®¢æˆ·ç«¯**æœ¬åœ°**åˆ é™¤ä»¤ç‰Œçš„æ–¹å¼å®ç°ï¼ŒæŒ‡çš„æ˜¯æ¸…æ¥šæœ¬åœ° Cookieã€localStorage çš„ä»¤ç‰Œç¼“å­˜ã€‚

åœ¨ Spring Security OAuth2 ä¸­ï¼Œ**å¹¶æ²¡æœ‰æä¾›å†…ç½®çš„æ¥å£**ï¼Œæ‰€ä»¥éœ€è¦è‡ªå·±å»å®ç°ã€‚ç¬”è€…å‚çœ‹ [ã€ŠSpring Security OAuth2 â€“ Simple Token Revocationã€‹](https://www.baeldung.com/spring-security-oauth-revoke-tokens) æ–‡æ¡£ï¼Œå®ç°åˆ é™¤ä»¤ç‰Œçš„ API æ¥å£ã€‚

å…·ä½“çš„å®ç°ï¼Œé€šè¿‡è°ƒç”¨ [ConsumerTokenServices](https://github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/provider/token/ConsumerTokenServices.java) çš„ `#revokeToken(String tokenValue)` æ–¹æ³•ï¼Œåˆ é™¤**è®¿é—®**ä»¤ç‰Œå’Œ**åˆ·æ–°**ä»¤ç‰Œã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/71.png)

8.1 ç¤ºä¾‹é¡¹ç›®
--------

ä¸‹é¢ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨**æˆæƒ**æœåŠ¡å™¨ [`lab-68-demo03-authorization-server-with-resource-owner-password-credentials`](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo03-authorization-server-with-resource-owner-password-credentials/) é¡¹ç›®ï¼Œä¿®æ”¹æ¥å…¥åˆ é™¤ä»¤ç‰Œçš„åŠŸèƒ½ã€‚æ”¹åŠ¨ç‚¹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/72.png)

â‘  åˆ›å»º [TokenDemoController](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo03-authorization-server-with-resource-owner-password-credentials/src/main/java/cn/iocoder/springboot/lab68/authorizationserverdemo/controller/TokenDemoController.java) ç±»ï¼Œæä¾› `/token/demo/revoke` æ¥å£ï¼Œè°ƒç”¨ ConsumerTokenServices çš„ `#revokeToken(String tokenValue)` æ–¹æ³•ï¼Œåˆ é™¤**è®¿é—®**ä»¤ç‰Œå’Œ**åˆ·æ–°**ä»¤ç‰Œã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@RestController
@RequestMapping("/token/demo")
public class TokenDemoController {

    @Autowired
    private ConsumerTokenServices tokenServices;

    @PostMapping(value = "/revoke")
    public boolean revokeToken(@RequestParam("token") String token) {
        return tokenServices.revokeToken(token);
    }

}
```

â‘¡ åœ¨ [SecurityConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-68-spring-security-oauth/lab-68-demo03-authorization-server-with-resource-owner-password-credentials/src/main/java/cn/iocoder/springboot/lab68/authorizationserverdemo/config/SecurityConfig.java) é…ç½®ç±»ï¼Œè®¾ç½® `/token/demo/revoke` æ¥å£**æ— éœ€æˆæƒ**ï¼Œæ–¹ä¾¿æµ‹è¯•ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@Override
protected void configure(HttpSecurity http) throws Exception {
    http.csrf().disable()
            .authorizeRequests()
            
            .mvcMatchers("/token/demo/revoke").permitAll()
            
            .anyRequest().authenticated();
}
```

8.2 ç®€å•æµ‹è¯•
--------

æ‰§è¡Œ AuthorizationServerApplication å¯åŠ¨æˆæƒæœåŠ¡å™¨ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬ä½¿ç”¨ **Postman æ¨¡æ‹Ÿä¸€ä¸ª Client**ã€‚

â‘  `POST` è¯·æ±‚ [http://localhost:8080/oauth/token](http://localhost:8080/oauth/token) åœ°å€ï¼Œä½¿ç”¨**å¯†ç **æ¨¡å¼è¿›è¡Œ**æˆæƒ**ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/73.png)

â‘¡ `POST` è¯·æ±‚ [http://localhost:8080/token/demo/revoke](http://localhost:8080/token/demo/revoke) åœ°å€ï¼Œåˆ é™¤ä»¤ç‰Œã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/74.png)

åˆ é™¤æˆåŠŸã€‚åç»­ï¼Œèƒ–å‹å¯ä»¥è‡ªå·±è°ƒç”¨**æˆæƒ**æœåŠ¡å™¨çš„ `oauth/check_token` æ¥å£ï¼Œæµ‹è¯•**è®¿é—®**ä»¤ç‰Œæ˜¯å¦å·²ç»è¢«åˆ é™¤ã€‚

è‡³æ­¤ï¼Œæˆ‘ä»¬å®Œæ•´å­¦ä¹  Spring Security OAuth æ¡†æ¶ã€‚ä¸è¿‡ Spring å›¢é˜Ÿå®£å¸ƒè¯¥æ¡†æ¶å¤„äº Deprecation **åºŸå¼ƒ**çŠ¶æ€ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](http://www.iocoder.cn/images/Spring-Security/2020-01-01/81.png)

åŒæ—¶ï¼ŒSpring å›¢é˜Ÿæ­£åœ¨å®ç°æ–°çš„ [Spring Authorization Server](https://github.com/spring-projects-experimental/spring-authorization-server) **æˆæƒ**æœåŠ¡å™¨ï¼Œç›®å‰è¿˜å¤„äº Experimental **å®éªŒ**çŠ¶æ€ã€‚

å®é™…é¡¹ç›®ä¸­ï¼Œæ ¹æ®è‰¿è‰¿äº†è§£åˆ°çš„æƒ…å†µï¼Œå¾ˆå°‘é¡¹ç›®ä¼šç›´æ¥é‡‡ç”¨ Spring Security OAuth æ¡†æ¶ï¼Œè€Œæ˜¯**è‡ªå·±å‚è€ƒå®ƒè¿›è¡Œ OAuth2.0 çš„å®ç°**ã€‚å¹¶ä¸”ï¼Œä¸€èˆ¬åªä¼šå®ç°**å¯†ç **æˆæƒæ¨¡å¼ã€‚

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨åŸºäº**å†…å­˜**çš„ [InMemoryTokenStore](https://github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/provider/token/store/InMemoryTokenStore.java)ï¼Œå®ç°**è®¿é—®**ä»¤ç‰Œå’Œ**åˆ·æ–°**ä»¤ç‰Œçš„å­˜å‚¨ã€‚å®ƒä¼šå­˜åœ¨ä¸¤ä¸ªæ˜æ˜¾çš„**ç¼ºç‚¹**ï¼š

*   **é‡å¯**æˆæƒæœåŠ¡å™¨æ—¶ï¼Œä»¤ç‰Œä¿¡æ¯ä¼š**ä¸¢å¤±**ï¼Œå¯¼è‡´ç”¨æˆ·éœ€è¦é‡æ–°æˆæƒã€‚
*   **å¤šä¸ª**æˆæƒæœåŠ¡å™¨æ—¶ï¼Œä»¤ç‰Œä¿¡æ¯æ— æ³•**å…±äº«**ï¼Œå¯¼è‡´ç”¨æˆ·ä¸€ä¼šæˆæƒæˆåŠŸï¼Œä¸€ä¼šæˆæƒå¤±è´¥ã€‚

å› æ­¤ï¼Œä¸‹ä¸€ç¯‡[ã€ŠèŠ‹é“ Spring Security OAuth2 å­˜å‚¨å™¨ã€‹](http://www.iocoder.cn/Spring-Security/OAuth2-learning-store/?self)æ–‡ç« ï¼Œæˆ‘ä»¬æ¥å­¦ä¹  Spring Security OAuth æä¾›çš„åŸºäº**æ•°æ®åº“**å’Œ **Redis** çš„å­˜å‚¨å™¨ã€‚èµ°èµ·~